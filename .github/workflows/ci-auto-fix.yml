name: CI Auto Fix

on:
  workflow_run:
    workflows: ["Build Custom VyOS ISO"]
    types: [completed]

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get failed workflow logs
        id: get-logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log-failed > /tmp/failed_logs.txt 2>&1 || true
          tail -100 /tmp/failed_logs.txt > /tmp/error_summary.txt
          echo "error_log<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/error_summary.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze with Claude API
        id: analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # „Ç®„É©„Éº„É≠„Ç∞„ÇíË™≠„ÅøËæº„Åø
          ERROR_LOG=$(cat /tmp/error_summary.txt)

          # „ÉØ„Éº„ÇØ„Éï„É≠„Éº„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø
          WORKFLOW_CONTENT=$(cat .github/workflows/build-vyos.yml)

          # Claude API„Å´ÈÄÅ‰ø°
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @- <<PAYLOAD
          {
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 4096,
            "messages": [
              {
                "role": "user",
                "content": "GitHub Actions CI„ÅåÂ§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç®„É©„Éº„É≠„Ç∞„Å®ÁèæÂú®„ÅÆ„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Éï„Ç°„Ç§„É´„ÇíÂàÜÊûê„Åó„ÄÅ‰øÆÊ≠£„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ‰øÆÊ≠£Âæå„ÅÆ„Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n## „Ç®„É©„Éº„É≠„Ç∞ (ÊúÄÂæå„ÅÆ100Ë°å)\n\`\`\`\n${ERROR_LOG}\n\`\`\`\n\n## ÁèæÂú®„ÅÆ„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Éï„Ç°„Ç§„É´ (.github/workflows/build-vyos.yml)\n\`\`\`yaml\n${WORKFLOW_CONTENT}\n\`\`\`\n\n## Âá∫ÂäõÂΩ¢Âºè\n‰øÆÊ≠£„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\n\n---FIX_START---\n„Éï„Ç°„Ç§„É´„Éë„Çπ: .github/workflows/build-vyos.yml\n---CONTENT_START---\n(‰øÆÊ≠£Âæå„ÅÆ„Éï„Ç°„Ç§„É´ÂÜÖÂÆπÂÖ®‰Ωì)\n---CONTENT_END---\n---FIX_END---\n\n‰øÆÊ≠£„Åå‰∏çË¶Å„Å™Â†¥Âêà„ÇÑ„ÄÅ„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Éï„Ç°„Ç§„É´‰ª•Â§ñ„ÅÆÂïèÈ°å„ÅÆÂ†¥Âêà„ÅØ:\n---NO_FIX---\nÁêÜÁî±: (‰øÆÊ≠£„Åå‰∏çË¶Å„Å™ÁêÜÁî±)\n---END---"
              }
            ]
          }
PAYLOAD
          )

          # „É¨„Çπ„Éù„É≥„Çπ„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫
          echo "$RESPONSE" | jq -r '.content[0].text' > /tmp/claude_response.txt
          cat /tmp/claude_response.txt

      - name: Apply fix if needed
        id: apply-fix
        run: |
          RESPONSE=$(cat /tmp/claude_response.txt)

          if echo "$RESPONSE" | grep -q "---FIX_START---"; then
            echo "Fix detected, applying..."

            # „Éï„Ç°„Ç§„É´„Éë„Çπ„ÇíÊäΩÂá∫
            FILE_PATH=$(echo "$RESPONSE" | sed -n 's/„Éï„Ç°„Ç§„É´„Éë„Çπ: \(.*\)/\1/p' | tr -d ' ')

            # ‰øÆÊ≠£ÂÜÖÂÆπ„ÇíÊäΩÂá∫
            echo "$RESPONSE" | sed -n '/---CONTENT_START---/,/---CONTENT_END---/p' | \
              sed '1d;$d' > /tmp/fixed_content.txt

            # „Éï„Ç°„Ç§„É´„ÇíÊõ¥Êñ∞
            cp /tmp/fixed_content.txt "$FILE_PATH"

            echo "has_fix=true" >> $GITHUB_OUTPUT
            echo "Fixed: $FILE_PATH"
          else
            echo "No fix needed or not a workflow issue"
            echo "$RESPONSE" | grep -A5 "---NO_FIX---" || true
            echo "has_fix=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.apply-fix.outputs.has_fix == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(ci): auto-fix CI failure"
          title: "fix(ci): Auto-fix CI failure from workflow run #${{ github.event.workflow_run.id }}"
          body: |
            ## Summary
            This PR was automatically generated to fix a CI failure.

            **Failed workflow run:** #${{ github.event.workflow_run.id }}

            ## Analysis
            See Claude's analysis in the workflow logs.

            ---
            ü§ñ Generated with Claude API
          branch: fix/ci-auto-${{ github.event.workflow_run.id }}
          delete-branch: true
