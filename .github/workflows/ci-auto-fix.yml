name: CI Auto Fix

on:
  workflow_run:
    workflows: ["Build Custom VyOS ISO", "Build VyOS Kernel with Signed r8126 Module"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get failed workflow logs
        id: get-logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log-failed > /tmp/failed_logs.txt 2>&1 || true
          tail -100 /tmp/failed_logs.txt > /tmp/error_summary.txt

      - name: Analyze with Claude API
        id: analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
          ERROR_LOG_B64=$(base64 -w0 /tmp/error_summary.txt)
          WORKFLOW_B64=$(base64 -w0 .github/workflows/build-vyos.yml)

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          PROMPT="GitHub Actions CIãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¨ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æžã—ã€ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ä¿®æ­£å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

          ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° (Base64): ${ERROR_LOG_B64}
          ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ« (Base64): ${WORKFLOW_B64}

          Base64ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

          å‡ºåŠ›å½¢å¼:
          ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ã€ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:

          ---FIX_START---
          ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: .github/workflows/build-vyos.yml
          ---CONTENT_START---
          (ä¿®æ­£å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹å…¨ä½“)
          ---CONTENT_END---
          ---FIX_END---

          ä¿®æ­£ãŒä¸è¦ãªå ´åˆã‚„ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ä»¥å¤–ã®å•é¡Œã®å ´åˆã¯:
          ---NO_FIX---
          ç†ç”±: (ä¿®æ­£ãŒä¸è¦ãªç†ç”±)
          ---END---"

          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
          jq -n --arg prompt "$PROMPT" '{
            model: "claude-sonnet-4-20250514",
            max_tokens: 4096,
            messages: [{role: "user", content: $prompt}]
          }' > /tmp/payload.json

          # Claude APIã«é€ä¿¡
          curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @/tmp/payload.json > /tmp/response.json

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
          jq -r '.content[0].text // "API Error: " + (.error.message // "Unknown error")' /tmp/response.json > /tmp/claude_response.txt
          cat /tmp/claude_response.txt

      - name: Apply fix if needed
        id: apply-fix
        run: |
          RESPONSE=$(cat /tmp/claude_response.txt)

          if echo "$RESPONSE" | grep -qF -- "---FIX_START---"; then
            echo "Fix detected, applying..."

            # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŠ½å‡º
            FILE_PATH=$(echo "$RESPONSE" | sed -n 's/ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: \(.*\)/\1/p' | tr -d ' ')

            # ä¿®æ­£å†…å®¹ã‚’æŠ½å‡º
            echo "$RESPONSE" | sed -n '/---CONTENT_START---/,/---CONTENT_END---/p' | \
              sed '1d;$d' > /tmp/fixed_content.txt

            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
            cp /tmp/fixed_content.txt "$FILE_PATH"

            echo "has_fix=true" >> $GITHUB_OUTPUT
            echo "Fixed: $FILE_PATH"
          else
            echo "No fix needed or not a workflow issue"
            echo "$RESPONSE" | grep -aF -- "---NO_FIX---" | head -5 || true
            echo "has_fix=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.apply-fix.outputs.has_fix == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(ci): auto-fix CI failure"
          title: "fix(ci): Auto-fix CI failure from workflow run #${{ github.event.workflow_run.id }}"
          body: |
            ## Summary
            This PR was automatically generated to fix a CI failure.

            **Failed workflow run:** #${{ github.event.workflow_run.id }}

            ## Analysis
            See Claude's analysis in the workflow logs.

            ---
            ðŸ¤– Generated with Claude API
          branch: fix/ci-auto-${{ github.event.workflow_run.id }}
          delete-branch: true
