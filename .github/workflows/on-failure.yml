name: On Failure - Auto Fix

# Reusable workflow: CIÂ§±ÊïóÊôÇ„ÅÆËá™Âãï‰øÆÊ≠£
# ‰Ωø„ÅÑÊñπ:
#   jobs:
#     on-failure:
#       if: failure()
#       needs: [your-job]
#       uses: ./.github/workflows/on-failure.yml
#       secrets: inherit

on:
  workflow_call:
    inputs:
      workflow_name:
        description: "Failed workflow name"
        required: false
        type: string
        default: ""

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get failed workflow info
        id: info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Workflow Run Info ==="
          echo "Run ID: ${{ github.run_id }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Repository: ${{ github.repository }}"

          # Â§±Êïó„Åó„Åü„Ç∏„Éß„Éñ„ÅÆ„É≠„Ç∞„ÇíÂèñÂæó
          gh run view ${{ github.run_id }} --log-failed > /tmp/failed_logs.txt 2>&1 || true

          # „É≠„Ç∞„ÅåÂ§ß„Åç„Åô„Åé„ÇãÂ†¥Âêà„ÅØÊú´Â∞æ„ÅÆ„Åø
          tail -200 /tmp/failed_logs.txt > /tmp/error_summary.txt

          echo "=== Error Summary (last 50 lines) ==="
          tail -50 /tmp/error_summary.txt

      - name: Find related workflow file
        id: find-workflow
        run: |
          # ÁèæÂú®„ÅÆ„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÂêç„Åã„Çâ„Éï„Ç°„Ç§„É´„ÇíÁâπÂÆö
          WORKFLOW_NAME="${{ github.workflow }}"
          echo "Looking for workflow: ${WORKFLOW_NAME}"

          # .github/workflows/ ÂÜÖ„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢
          WORKFLOW_FILE=""
          for f in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$f" ]; then
              if grep -q "^name: ${WORKFLOW_NAME}$" "$f" 2>/dev/null || \
                 grep -q "^name: \"${WORKFLOW_NAME}\"$" "$f" 2>/dev/null || \
                 grep -q "^name: '${WORKFLOW_NAME}'$" "$f" 2>/dev/null; then
                WORKFLOW_FILE="$f"
                break
              fi
            fi
          done

          if [ -n "${WORKFLOW_FILE}" ]; then
            echo "Found workflow file: ${WORKFLOW_FILE}"
            echo "workflow_file=${WORKFLOW_FILE}" >> "$GITHUB_OUTPUT"
          else
            echo "Workflow file not found for: ${WORKFLOW_NAME}"
            echo "workflow_file=" >> "$GITHUB_OUTPUT"
          fi

      - name: Analyze with Claude API
        id: analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # API„Ç≠„Éº„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ANTHROPIC_API_KEY is not set, skipping analysis"
            echo "skipped=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          WORKFLOW_FILE="${{ steps.find-workflow.outputs.workflow_file }}"

          # „Ç®„É©„Éº„É≠„Ç∞„ÇíË™≠„ÅøËæº„Åø
          ERROR_LOG=$(cat /tmp/error_summary.txt | head -c 10000)

          # „ÉØ„Éº„ÇØ„Éï„É≠„Éº„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ
          if [ -n "${WORKFLOW_FILE}" ] && [ -f "${WORKFLOW_FILE}" ]; then
            WORKFLOW_CONTENT=$(cat "${WORKFLOW_FILE}" | head -c 15000)
          else
            WORKFLOW_CONTENT="(workflow file not found)"
          fi

          # „Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàê
          cat > /tmp/prompt.txt << 'PROMPT_EOF'
          GitHub Actions CI„ÅåÂ§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç®„É©„Éº„É≠„Ç∞„Å®„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Éï„Ç°„Ç§„É´„ÇíÂàÜÊûê„Åó„ÄÅ‰øÆÊ≠£Ê°à„ÇíÊèêÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          ## „Ç®„É©„Éº„É≠„Ç∞
          ```
          ERROR_LOG_PLACEHOLDER
          ```

          ## „ÉØ„Éº„ÇØ„Éï„É≠„Éº„Éï„Ç°„Ç§„É´ (WORKFLOW_FILE_PLACEHOLDER)
          ```yaml
          WORKFLOW_CONTENT_PLACEHOLDER
          ```

          ## Âá∫ÂäõÂΩ¢Âºè

          ‰øÆÊ≠£„ÅåÂøÖË¶Å„Å™Â†¥Âêà:
          ---FIX_START---
          „Éï„Ç°„Ç§„É´„Éë„Çπ: (‰øÆÊ≠£„Åô„Çã„Éï„Ç°„Ç§„É´„ÅÆ„Éë„Çπ)
          Ë™¨Êòé: (‰Ωï„Çí‰øÆÊ≠£„Åô„Çã„Åã„ÄÅ„Å™„Åú‰øÆÊ≠£„ÅåÂøÖË¶Å„Åã)
          ---CONTENT_START---
          (‰øÆÊ≠£Âæå„ÅÆ„Éï„Ç°„Ç§„É´ÂÜÖÂÆπÂÖ®‰Ωì)
          ---CONTENT_END---
          ---FIX_END---

          ‰øÆÊ≠£„Åå‰∏çË¶Å/‰∏çÂèØËÉΩ„Å™Â†¥Âêà:
          ---NO_FIX---
          ÁêÜÁî±: (‰øÆÊ≠£„Åå‰∏çË¶Å/‰∏çÂèØËÉΩ„Å™ÁêÜÁî±)
          Êé®Â•®„Ç¢„ÇØ„Ç∑„Éß„É≥: (ÊâãÂãï„ÅßË°å„ÅÜ„Åπ„ÅçÂØæÂøú)
          ---END---
          PROMPT_EOF

          # „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíÁΩÆÊèõ
          sed -i "s|ERROR_LOG_PLACEHOLDER|${ERROR_LOG}|g" /tmp/prompt.txt 2>/dev/null || true
          sed -i "s|WORKFLOW_FILE_PLACEHOLDER|${WORKFLOW_FILE}|g" /tmp/prompt.txt 2>/dev/null || true
          sed -i "s|WORKFLOW_CONTENT_PLACEHOLDER|${WORKFLOW_CONTENT}|g" /tmp/prompt.txt 2>/dev/null || true

          PROMPT=$(cat /tmp/prompt.txt)

          # Claude API„Å´ÈÄÅ‰ø°
          jq -n --arg prompt "$PROMPT" '{
            model: "claude-sonnet-4-20250514",
            max_tokens: 8192,
            messages: [{role: "user", content: $prompt}]
          }' > /tmp/payload.json

          curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @/tmp/payload.json > /tmp/response.json

          # „É¨„Çπ„Éù„É≥„Çπ„ÇíÊäΩÂá∫
          jq -r '.content[0].text // "API Error: " + (.error.message // "Unknown error")' /tmp/response.json > /tmp/claude_response.txt

          echo "=== Claude Response ==="
          cat /tmp/claude_response.txt

      - name: Apply fix and create PR
        id: apply-fix
        if: steps.analyze.outputs.skipped != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESPONSE=$(cat /tmp/claude_response.txt)

          if echo "$RESPONSE" | grep -qF -- "---FIX_START---"; then
            echo "Fix detected, applying..."

            # „Éï„Ç°„Ç§„É´„Éë„Çπ„ÇíÊäΩÂá∫
            FILE_PATH=$(echo "$RESPONSE" | sed -n 's/^„Éï„Ç°„Ç§„É´„Éë„Çπ: *\(.*\)/\1/p' | tr -d ' ' | head -1)

            # Ë™¨Êòé„ÇíÊäΩÂá∫
            DESCRIPTION=$(echo "$RESPONSE" | sed -n 's/^Ë™¨Êòé: *\(.*\)/\1/p' | head -1)

            if [ -z "${FILE_PATH}" ]; then
              echo "::warning::Could not extract file path from response"
              echo "has_fix=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "File to fix: ${FILE_PATH}"
            echo "Description: ${DESCRIPTION}"

            # ‰øÆÊ≠£ÂÜÖÂÆπ„ÇíÊäΩÂá∫
            echo "$RESPONSE" | sed -n '/---CONTENT_START---/,/---CONTENT_END---/p' | \
              sed '1d;$d' > /tmp/fixed_content.txt

            if [ ! -s /tmp/fixed_content.txt ]; then
              echo "::warning::Fixed content is empty"
              echo "has_fix=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # „Éñ„É©„É≥„ÉÅ„Çí‰ΩúÊàê
            BRANCH_NAME="fix/auto-fix-${{ github.run_id }}"
            git checkout -b "${BRANCH_NAME}"

            # „Éï„Ç°„Ç§„É´„ÇíÊõ¥Êñ∞
            mkdir -p "$(dirname "${FILE_PATH}")"
            cp /tmp/fixed_content.txt "${FILE_PATH}"

            # „Ç≥„Éü„ÉÉ„Éà
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "${FILE_PATH}"
            git commit -m "fix(ci): auto-fix for workflow run #${{ github.run_id }}

            ${DESCRIPTION}

            Co-Authored-By: Claude <noreply@anthropic.com>"

            # „Éó„ÉÉ„Ç∑„É•
            git push -u origin "${BRANCH_NAME}"

            # PR‰ΩúÊàê
            gh pr create \
              --title "fix(ci): Auto-fix for failed workflow run #${{ github.run_id }}" \
              --body "## Summary

            This PR was automatically generated to fix a CI failure.

            **Failed workflow:** ${{ github.workflow }}
            **Run ID:** #${{ github.run_id }}
            **Run URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ## Fix Description

            ${DESCRIPTION}

            ## Review Checklist

            - [ ] ‰øÆÊ≠£ÂÜÖÂÆπ„ÅåÈÅ©Âàá„ÅãÁ¢∫Ë™ç
            - [ ] ÊÑèÂõ≥„Åó„Å™„ÅÑÂ§âÊõ¥„Åå„Å™„ÅÑ„ÅãÁ¢∫Ë™ç
            - [ ] „ÉÜ„Çπ„Éà„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØÂÆüÊñΩ

            ---
            ü§ñ Generated with Claude API" \
              --head "${BRANCH_NAME}" \
              --base "${{ github.ref_name }}"

            echo "has_fix=true" >> "$GITHUB_OUTPUT"
            echo "::notice::PR created successfully"

          elif echo "$RESPONSE" | grep -qF -- "---NO_FIX---"; then
            echo "No automatic fix available"
            REASON=$(echo "$RESPONSE" | sed -n '/---NO_FIX---/,/---END---/p' | grep -v "^---")
            echo "::notice::${REASON}"
            echo "has_fix=false" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::Unexpected response format from Claude API"
            echo "has_fix=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue if no API key
        if: steps.analyze.outputs.skipped == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::warning::ANTHROPIC_API_KEY is not set. Creating issue for manual review."

          gh issue create \
            --title "CI Failure: ${{ github.workflow }} #${{ github.run_id }}" \
            --body "## CI Failure Detected

          **Workflow:** ${{ github.workflow }}
          **Run ID:** #${{ github.run_id }}
          **Run URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Error Log (last 50 lines)

          \`\`\`
          $(tail -50 /tmp/error_summary.txt)
          \`\`\`

          ## Next Steps

          1. Review the failed workflow run
          2. Identify the root cause
          3. Create a fix PR

          ---
          ü§ñ Auto-generated by on-failure workflow" \
            --label "bug,ci" || echo "::warning::Failed to create issue (labels may not exist)"

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL is not set, skipping notification"
            exit 0
          fi

          # „Ç®„É©„Éº„Çµ„Éû„É™„Éº„ÇíÂèñÂæó (ÊúÄÂ§ß500ÊñáÂ≠ó)
          ERROR_SUMMARY=""
          if [ -f /tmp/error_summary.txt ]; then
            ERROR_SUMMARY=$(tail -10 /tmp/error_summary.txt | head -c 500)
          fi

          # Discord EmbedÂΩ¢Âºè„Åß„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàê
          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "embeds": [{
              "title": "CI Failed: ${{ github.workflow }}",
              "description": "GitHub Actions workflow failed.",
              "color": 15158332,
              "fields": [
                {
                  "name": "Repository",
                  "value": "${{ github.repository }}",
                  "inline": true
                },
                {
                  "name": "Branch",
                  "value": "${{ github.ref_name }}",
                  "inline": true
                },
                {
                  "name": "Run ID",
                  "value": "[#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                  "inline": true
                },
                {
                  "name": "Error Summary",
                  "value": "\`\`\`${ERROR_SUMMARY}\`\`\`"
                }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF

          echo "Discord notification sent"
