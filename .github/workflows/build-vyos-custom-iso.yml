name: Build VyOS Custom ISO with r8126

# カスタムカーネル + 署名済みr8126モジュール + ISOを一括ビルド
# r8126モジュールはカーネルと同じ署名キーで署名されるため、insmodで読み込み可能
#
# 参考:
# - https://docs.vyos.io/en/latest/contributing/build-vyos.html
# - https://github.com/vyos/vyos-build

on:
  workflow_dispatch:
    inputs:
      vyos_branch:
        description: "VyOS branch (current, sagitta, circinus)"
        required: true
        default: "current"
        type: choice
        options:
          - current
          - sagitta
          - circinus
      kernel_version:
        description: "Kernel version (e.g., 6.6.117)"
        required: true
        default: "6.6.117"
        type: string
      build_type:
        description: "Build type"
        required: true
        default: "generic"
        type: choice
        options:
          - generic
          - cloud-init
  pull_request:
    paths:
      - ".github/workflows/build-vyos-custom-iso.yml"
      - "scripts/ci/**"

permissions:
  contents: write
  pull-requests: write
  actions: read

# グローバル環境変数
env:
  DEFAULT_VYOS_BRANCH: current
  DEFAULT_KERNEL_VERSION: "6.6.117"
  CACHE_VERSION: v1
  R8126_VERSION: "10.016.00"
  DOCKER_BUILDKIT: 1

jobs:
  build-custom-iso:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          set -euo pipefail
          echo "=== Before cleanup ==="
          df -h

          # 並列削除でスピードアップ
          sudo rm -rf /usr/share/dotnet &
          sudo rm -rf /usr/local/lib/android &
          sudo rm -rf /opt/ghc &
          sudo rm -rf /opt/hostedtoolcache/CodeQL &
          sudo rm -rf /opt/hostedtoolcache &
          wait

          # 未使用Dockerイメージを削除
          docker image prune -af || true

          echo "=== After cleanup ==="
          df -h

      - name: Set build variables
        id: vars
        run: |
          set -euo pipefail
          BRANCH="${{ github.event.inputs.vyos_branch || env.DEFAULT_VYOS_BRANCH }}"
          KERNEL_VERSION="${{ github.event.inputs.kernel_version || env.DEFAULT_KERNEL_VERSION }}"
          BUILD_DATE=$(date -u +%Y%m%d%H%M)
          VERSION="custom-${BUILD_DATE}"

          {
            echo "branch=${BRANCH}"
            echo "kernel_version=${KERNEL_VERSION}"
            echo "version=${VERSION}"
            echo "build_date=${BUILD_DATE}"
          } >> "$GITHUB_OUTPUT"

          echo "Branch: ${BRANCH}"
          echo "Kernel Version: ${KERNEL_VERSION}"
          echo "Version: ${VERSION}"

      - name: Cache vyos-build repository
        id: cache-vyos-build
        uses: actions/cache@v5
        with:
          path: vyos-build/.git
          key: vyos-build-git-${{ env.CACHE_VERSION }}-${{ steps.vars.outputs.branch }}-${{ hashFiles('.github/workflows/build-vyos-custom-iso.yml') }}
          restore-keys: |
            vyos-build-git-${{ env.CACHE_VERSION }}-${{ steps.vars.outputs.branch }}-

      - name: Cache kernel source
        id: cache-kernel
        uses: actions/cache@v5
        with:
          path: kernel-cache
          key: kernel-src-${{ env.CACHE_VERSION }}-${{ steps.vars.outputs.kernel_version }}

      - name: Cache ccache
        uses: actions/cache@v5
        with:
          path: ccache-cache
          key: ccache-${{ env.CACHE_VERSION }}-${{ steps.vars.outputs.kernel_version }}-${{ hashFiles('.github/workflows/build-vyos-custom-iso.yml') }}
          restore-keys: |
            ccache-${{ env.CACHE_VERSION }}-${{ steps.vars.outputs.kernel_version }}-
            ccache-${{ env.CACHE_VERSION }}-

      - name: Prepare cache directories
        run: |
          mkdir -p kernel-cache ccache-cache

      - name: Clone or restore vyos-build repository
        run: |
          set -euo pipefail
          BRANCH="${{ steps.vars.outputs.branch }}"

          if [ -d "vyos-build/.git" ]; then
            echo "Restoring vyos-build from cached .git directory..."
            cd vyos-build
            git checkout -- .
            git clean -fdx
            git fetch origin
            git reset --hard "origin/${BRANCH}"
            echo "=== Repository info (restored from cache) ==="
            git log -1 --oneline
          else
            echo "Cloning vyos-build branch: ${BRANCH}"
            git clone -b "${BRANCH}" --single-branch --depth 1 \
              https://github.com/vyos/vyos-build.git
            cd vyos-build
            echo "=== Repository info (fresh clone) ==="
            git log -1 --oneline
          fi
          ls -la

      - name: Pull VyOS build container
        run: |
          set -euo pipefail
          BRANCH="${{ steps.vars.outputs.branch }}"
          echo "Pulling Docker image: vyos/vyos-build:${BRANCH}"

          docker pull "vyos/vyos-build:${BRANCH}"
          docker images

      - name: Build custom kernel, r8126 module, and ISO
        id: build
        run: |
          set -euo pipefail
          cd vyos-build

          BRANCH="${{ steps.vars.outputs.branch }}"
          VERSION="${{ steps.vars.outputs.version }}"
          KERNEL_VERSION="${{ steps.vars.outputs.kernel_version }}"
          BUILD_TYPE="${{ github.event.inputs.build_type || 'generic' }}"

          echo "=== Build Configuration ==="
          echo "Branch: ${BRANCH}"
          echo "Kernel Version: ${KERNEL_VERSION}"
          echo "Version: ${VERSION}"
          echo "Build Type: ${BUILD_TYPE}"
          echo "=========================="

          # Copy build script to vyos-build directory
          cp "${{ github.workspace }}/scripts/ci/build-kernel-and-modules.sh" ./build-script.sh
          chmod +x ./build-script.sh

          # Run build in Docker container
          docker run --rm --privileged \
            -v "$(pwd):/vyos" \
            -v "${{ github.workspace }}/kernel-cache:/kernel-cache" \
            -v "${{ github.workspace }}/ccache-cache:/ccache" \
            -w /vyos \
            -e VYOS_VERSION="${VERSION}" \
            -e KERNEL_VERSION="${KERNEL_VERSION}" \
            -e BUILD_TYPE="${BUILD_TYPE}" \
            -e CCACHE_DIR="/ccache" \
            -e CCACHE_MAXSIZE="5G" \
            -e KBUILD_BUILD_TIMESTAMP="" \
            "vyos/vyos-build:${BRANCH}" \
            /vyos/build-script.sh

          echo "=== Final outputs ==="
          ls -la build/ || true
          ls -la custom-packages/ || true

      - name: Verify build output
        run: |
          set -euo pipefail
          cd vyos-build

          echo "=== Build artifacts ==="

          # Check for ISO
          if [ -d "build" ]; then
            ls -la build/
            ISO_FILE=$(ls -1 build/*.iso 2>/dev/null | head -1 || true)
            if [ -n "${ISO_FILE}" ]; then
              echo "ISO file: ${ISO_FILE}"
              echo "Size: $(du -h "${ISO_FILE}" | cut -f1)"
              sha256sum "${ISO_FILE}" | sudo tee "${ISO_FILE}.sha256"
            else
              echo "WARNING: No ISO file found in build/"
            fi
          fi

          # Check for custom packages
          if [ -d "custom-packages" ]; then
            echo ""
            echo "=== Custom packages ==="
            ls -la custom-packages/

            # Verify r8126 module is signed
            if [ -f "custom-packages/r8126-signed.ko" ]; then
              if strings custom-packages/r8126-signed.ko | grep -q "~Module signature appended~"; then
                echo "SUCCESS: r8126-signed.ko has valid signature"
              else
                echo "ERROR: r8126-signed.ko signature not found"
                exit 1
              fi
            fi

            # Show kernel config MODULE_SIG settings
            if [ -f "custom-packages/kernel-config" ]; then
              echo ""
              echo "=== MODULE_SIG settings ==="
              grep -E "MODULE_SIG" custom-packages/kernel-config | head -10
            fi
          fi

      - name: Generate build manifest
        if: success()
        run: |
          set -euo pipefail
          cd vyos-build

          ISO_FILE=$(ls -1 build/*.iso 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo "")
          DEB_FILES=$(ls -1 custom-packages/*.deb 2>/dev/null | xargs -I {} basename {} 2>/dev/null | jq -R . | jq -s . || echo "[]")

          cat > build-manifest.json << EOF
          {
            "build_id": "${{ github.run_id }}",
            "build_number": "${{ github.run_number }}",
            "commit_sha": "${{ github.sha }}",
            "vyos_branch": "${{ steps.vars.outputs.branch }}",
            "kernel_version": "${{ steps.vars.outputs.kernel_version }}",
            "version": "${{ steps.vars.outputs.version }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "actor": "${{ github.actor }}",
            "artifacts": {
              "iso": "${ISO_FILE}",
              "kernel_packages": ${DEB_FILES}
            }
          }
          EOF

          cat build-manifest.json

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v6
        with:
          name: vyos-custom-iso-${{ steps.vars.outputs.version }}
          path: |
            vyos-build/build/*.iso
            vyos-build/build/*.sha256
          retention-days: 7
          compression-level: 0
          if-no-files-found: warn

      - name: Upload kernel packages
        uses: actions/upload-artifact@v6
        with:
          name: vyos-kernel-packages-${{ steps.vars.outputs.version }}
          path: |
            vyos-build/custom-packages/*.deb
          retention-days: 30
          if-no-files-found: warn

      - name: Upload signed modules
        uses: actions/upload-artifact@v6
        with:
          name: signed-modules-${{ steps.vars.outputs.version }}
          path: |
            vyos-build/custom-packages/r8126-signed.ko
            vyos-build/custom-packages/signing_key.x509
            vyos-build/custom-packages/kernel-config
          retention-days: 30
          if-no-files-found: warn

      - name: Upload build manifest
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: build-manifest-${{ steps.vars.outputs.version }}
          path: vyos-build/build-manifest.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: build-log-${{ steps.vars.outputs.version }}
          path: |
            vyos-build/build/*.log
          retention-days: 3
          if-no-files-found: ignore

      - name: Monitor resource usage
        if: always()
        run: |
          echo "=== Disk Usage ==="
          df -h

          echo "=== Memory Usage ==="
          free -h || true

          echo "=== Cache Statistics ==="
          du -sh kernel-cache ccache-cache vyos-build/.git 2>/dev/null || true

      - name: Clean up for cache
        if: always()
        run: |
          # キャッシュ保存前にビルド成果物を削除
          # (tarエラーの原因となる特殊ファイルを含む)
          echo "Cleaning up build artifacts for cache..."

          # vyos-build内のビルド成果物を削除 (.gitは保持)
          if [ -d "vyos-build" ]; then
            cd vyos-build
            # buildディレクトリとkernel-buildを削除
            rm -rf build kernel-build packages custom-packages
            # その他の生成ファイルを削除
            rm -rf ./*.iso ./*.log build-script.sh build-manifest.json
            cd ..
          fi

          # ccacheの不要なtmpファイルを削除
          if [ -d "ccache-cache" ]; then
            find ccache-cache -name "*.tmp" -delete 2>/dev/null || true
          fi

          echo "Cleanup completed"
          du -sh vyos-build/.git ccache-cache kernel-cache 2>/dev/null || true

  # 失敗時の自動対応
  on_failure:
    if: failure()
    needs: [build-custom-iso]
    uses: ./.github/workflows/on-failure.yml
    secrets: inherit
