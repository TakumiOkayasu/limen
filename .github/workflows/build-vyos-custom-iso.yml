name: Build VyOS Custom ISO with r8126

# カスタムカーネル + 署名済みr8126モジュール + ISOを一括ビルド
# r8126モジュールはカーネルと同じ署名キーで署名されるため、insmodで読み込み可能
#
# 参考:
# - https://docs.vyos.io/en/latest/contributing/build-vyos.html
# - https://github.com/vyos/vyos-build

on:
  workflow_dispatch:
    inputs:
      vyos_branch:
        description: "VyOS branch (current, sagitta, circinus)"
        required: true
        default: "current"
        type: choice
        options:
          - current
          - sagitta
          - circinus
      kernel_version:
        description: "Kernel version (e.g., 6.6.117)"
        required: true
        default: "6.6.117"
        type: string
      build_type:
        description: "Build type"
        required: true
        default: "generic"
        type: choice
        options:
          - generic
          - cloud-init
  pull_request:
    paths:
      - ".github/workflows/build-vyos-custom-iso.yml"

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  build-custom-iso:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          echo "=== Before cleanup ==="
          df -h

          # 不要なツールを削除してディスク容量を確保
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/hostedtoolcache
          sudo docker image prune -af

          echo "=== After cleanup ==="
          df -h

      - name: Set build variables
        id: vars
        run: |
          BRANCH="${{ github.event.inputs.vyos_branch || 'current' }}"
          KERNEL_VERSION="${{ github.event.inputs.kernel_version || '6.6.117' }}"
          BUILD_DATE=$(date -u +%Y%m%d%H%M)
          VERSION="custom-${BUILD_DATE}"

          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "kernel_version=${KERNEL_VERSION}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT

          echo "Branch: ${BRANCH}"
          echo "Kernel Version: ${KERNEL_VERSION}"
          echo "Version: ${VERSION}"

      - name: Cache vyos-build repository
        id: cache-vyos-build
        uses: actions/cache@v5
        with:
          path: vyos-build/.git
          key: vyos-build-git-${{ steps.vars.outputs.branch }}-${{ hashFiles('.github/workflows/build-vyos-custom-iso.yml') }}
          restore-keys: |
            vyos-build-git-${{ steps.vars.outputs.branch }}-

      - name: Cache kernel source
        id: cache-kernel
        uses: actions/cache@v5
        with:
          path: kernel-cache
          key: kernel-src-${{ steps.vars.outputs.kernel_version }}

      - name: Cache ccache
        uses: actions/cache@v5
        with:
          path: ccache-cache
          key: ccache-${{ steps.vars.outputs.kernel_version }}-${{ hashFiles('.github/workflows/build-vyos-custom-iso.yml') }}
          restore-keys: |
            ccache-${{ steps.vars.outputs.kernel_version }}-
            ccache-

      - name: Prepare cache directories
        run: |
          mkdir -p kernel-cache ccache-cache

      - name: Clone or restore vyos-build repository
        run: |
          BRANCH="${{ steps.vars.outputs.branch }}"

          if [ -d "vyos-build/.git" ]; then
            echo "Restoring vyos-build from cached .git directory..."
            cd vyos-build
            git checkout -- .
            git clean -fdx
            git fetch origin
            git reset --hard origin/${BRANCH}
            echo "=== Repository info (restored from cache) ==="
            git log -1 --oneline
          else
            echo "Cloning vyos-build branch: ${BRANCH}"
            git clone -b "${BRANCH}" --single-branch --depth 1 \
              https://github.com/vyos/vyos-build.git
            cd vyos-build
            echo "=== Repository info (fresh clone) ==="
            git log -1 --oneline
          fi
          ls -la

      - name: Pull VyOS build container
        run: |
          BRANCH="${{ steps.vars.outputs.branch }}"
          echo "Pulling Docker image: vyos/vyos-build:${BRANCH}"

          docker pull "vyos/vyos-build:${BRANCH}"
          docker images

      - name: Build custom kernel, r8126 module, and ISO
        run: |
          cd vyos-build

          BRANCH="${{ steps.vars.outputs.branch }}"
          VERSION="${{ steps.vars.outputs.version }}"
          KERNEL_VERSION="${{ steps.vars.outputs.kernel_version }}"
          BUILD_TYPE="${{ github.event.inputs.build_type || 'generic' }}"

          echo "=== Build Configuration ==="
          echo "Branch: ${BRANCH}"
          echo "Kernel Version: ${KERNEL_VERSION}"
          echo "Version: ${VERSION}"
          echo "Build Type: ${BUILD_TYPE}"
          echo "=========================="

          # 統合ビルドスクリプト
          # カーネルとr8126を同じ署名キーでビルドし、ISOに含める
          docker run --rm --privileged \
            -v "$(pwd):/vyos" \
            -v "${{ github.workspace }}/kernel-cache:/kernel-cache" \
            -v "${{ github.workspace }}/ccache-cache:/ccache" \
            -w /vyos \
            -e VYOS_VERSION="${VERSION}" \
            -e KERNEL_VERSION="${KERNEL_VERSION}" \
            -e BUILD_TYPE="${BUILD_TYPE}" \
            -e CCACHE_DIR="/ccache" \
            -e CCACHE_MAXSIZE="5G" \
            -e KBUILD_BUILD_TIMESTAMP="" \
            "vyos/vyos-build:${BRANCH}" \
            bash -c '
              set -e

              echo "============================================="
              echo "=== Phase 1: Build Custom Kernel ==="
              echo "============================================="

              # Install build dependencies with ccache
              sudo apt-get update
              sudo apt-get install -y curl flex bison bc libssl-dev libelf-dev \
                libncurses-dev dwarves kmod cpio rsync debhelper fakeroot dpkg-dev ccache

              # Setup ccache (size set via env var CCACHE_MAXSIZE=5G)
              export PATH="/usr/lib/ccache:$PATH"
              ccache -s || true

              WORK_DIR=/vyos/kernel-build
              mkdir -p ${WORK_DIR}
              cd ${WORK_DIR}

              # Get VyOS kernel config
              DEFCONFIG_PATH="/vyos/scripts/package-build/linux-kernel/arch/x86/configs/vyos_defconfig"

              MAJOR_VERSION=$(echo $KERNEL_VERSION | cut -d. -f1)

              # Use cached kernel source if available
              KERNEL_TARBALL="linux-${KERNEL_VERSION}.tar.xz"
              if [ -f "/kernel-cache/${KERNEL_TARBALL}" ]; then
                echo "Using cached kernel source..."
                cp "/kernel-cache/${KERNEL_TARBALL}" .
              else
                echo "Downloading kernel ${KERNEL_VERSION}..."
                curl -L -O "https://cdn.kernel.org/pub/linux/kernel/v${MAJOR_VERSION}.x/${KERNEL_TARBALL}"
                cp "${KERNEL_TARBALL}" "/kernel-cache/" || true
              fi

              tar xf "${KERNEL_TARBALL}"
              cd linux-${KERNEL_VERSION}

              if [ -f "${DEFCONFIG_PATH}" ]; then
                echo "Using VyOS defconfig from scripts/package-build..."
                cp "${DEFCONFIG_PATH}" .config
                make olddefconfig
              else
                echo "VyOS defconfig not found at ${DEFCONFIG_PATH}, searching..."
                find /vyos -name "vyos_defconfig" -type f 2>/dev/null || true
                echo "ERROR: VyOS defconfig is required for proper MODULE_SIG settings"
                exit 1
              fi

              echo "=== Generating module signing keys ==="
              mkdir -p certs

              # x509.genkey content (base64 encoded)
              echo "W3JlcV0KZGVmYXVsdF9iaXRzID0gNDA5NgpkaXN0aW5ndWlzaGVkX25hbWUgPSByZXFfZGlzdGluZ3Vpc2hlZF9uYW1lCnByb21wdCA9IG5vCng1MDlfZXh0ZW5zaW9ucyA9IHYzX2NhCgpbcmVxX2Rpc3Rpbmd1aXNoZWRfbmFtZV0KQ04gPSBWeU9TIE1vZHVsZSBTaWduaW5nIEtleQplbWFpbEFkZHJlc3MgPSBidWlsZEB2eW9zLmxvY2FsCgpbdjNfY2FdCmJhc2ljQ29uc3RyYWludHM9Y3JpdGljYWwsQ0E6RkFMU0UKa2V5VXNhZ2U9ZGlnaXRhbFNpZ25hdHVyZQpzdWJqZWN0S2V5SWRlbnRpZmllcj1oYXNoCmF1dGhvcml0eUtleUlkZW50aWZpZXI9a2V5aWQK" | base64 -d > x509.genkey

              openssl req -new -nodes -utf8 -sha512 -days 36500 \
                -batch -x509 -config x509.genkey \
                -outform PEM -out certs/signing_key.pem \
                -keyout certs/signing_key.pem

              # Set signing key path
              ./scripts/config --set-str MODULE_SIG_KEY "certs/signing_key.pem"
              ./scripts/config --set-str SYSTEM_TRUSTED_KEYS ""
              ./scripts/config --enable MODULE_SIG_ALL
              make olddefconfig

              echo "=== Verifying MODULE_SIG settings ==="
              grep -E "MODULE_SIG|SYSTEM_TRUSTED" .config || true
              if ! grep -q "CONFIG_MODULE_SIG=y" .config; then
                echo "ERROR: CONFIG_MODULE_SIG is not enabled!"
                exit 1
              fi
              if ! grep -q "CONFIG_MODULE_SIG_ALL=y" .config; then
                echo "ERROR: CONFIG_MODULE_SIG_ALL is not enabled!"
                exit 1
              fi
              echo "MODULE_SIG is properly configured."

              echo "=== Building kernel ==="
              git init
              git config user.email "build@vyos.local"
              git config user.name "VyOS Kernel Builder"
              git add -A
              git commit -m "Initial commit for kernel build"

              # Disable debug info to speed up build (saves ~10-15 min)
              ./scripts/config --disable DEBUG_INFO
              ./scripts/config --disable DEBUG_INFO_DWARF4
              ./scripts/config --disable DEBUG_INFO_DWARF5
              ./scripts/config --disable DEBUG_INFO_BTF

              # Disable unused drivers/features for router use case (saves ~5-10 min)
              # NOTE: USB_SUPPORT must remain ENABLED for USB boot/installation
              # Sound (not needed)
              ./scripts/config --disable SOUND || true
              # Media/TV (not needed)
              ./scripts/config --disable MEDIA_SUPPORT || true
              # Wireless (using wired NICs only)
              ./scripts/config --disable WIRELESS || true
              ./scripts/config --disable CFG80211 || true
              ./scripts/config --disable MAC80211 || true
              # GPU/DRM (headless server)
              ./scripts/config --disable DRM || true
              # Staging drivers (experimental, not needed)
              ./scripts/config --disable STAGING || true

              make olddefconfig

              # Build with ccache (CC="ccache gcc")
              make -j$(nproc) CC="ccache gcc" deb-pkg LOCALVERSION=-vyos KDEB_PKGVERSION=1-1

              # Show ccache stats
              echo "=== ccache stats ==="
              ccache -s || true

              # Save kernel packages
              mkdir -p /vyos/custom-packages
              mv ../*.deb /vyos/custom-packages/

              echo "=== Kernel packages ==="
              ls -la /vyos/custom-packages/

              echo "============================================="
              echo "=== Phase 2: Build and Sign r8126 Driver ==="
              echo "============================================="

              cd /tmp
              curl -L -o r8126.tar.bz2 https://github.com/openwrt/rtl8126/releases/download/10.016.00/r8126-10.016.00.tar.bz2
              tar xjf r8126.tar.bz2
              cd r8126-10.016.00/src

              KERNEL_DIR=${WORK_DIR}/linux-${KERNEL_VERSION}
              echo "Building r8126 module against ${KERNEL_DIR}..."
              make -C ${KERNEL_DIR} M=$(pwd) modules

              echo "=== Signing r8126 module ==="
              ${KERNEL_DIR}/scripts/sign-file sha512 \
                ${KERNEL_DIR}/certs/signing_key.pem \
                ${KERNEL_DIR}/certs/signing_key.pem \
                r8126.ko

              echo "Verifying module signature..."
              if strings r8126.ko | grep -q "~Module signature appended~"; then
                echo "SUCCESS: r8126.ko is signed"
              else
                echo "WARNING: Module signature not detected"
              fi

              # Save signed module and signing key
              cp r8126.ko /vyos/custom-packages/r8126-signed.ko
              openssl x509 -in ${KERNEL_DIR}/certs/signing_key.pem -outform DER -out /vyos/custom-packages/signing_key.x509
              cp ${KERNEL_DIR}/.config /vyos/custom-packages/kernel-config

              # Create .deb package for r8126 module
              echo "=== Creating r8126 .deb package ==="
              KVER="${KERNEL_VERSION}-vyos"
              PKG_DIR=/tmp/r8126-dkms
              mkdir -p ${PKG_DIR}/lib/modules/${KVER}/kernel/drivers/net/ethernet/realtek
              mkdir -p ${PKG_DIR}/DEBIAN

              cp r8126.ko ${PKG_DIR}/lib/modules/${KVER}/kernel/drivers/net/ethernet/realtek/

              # Create debian control file (using printf to avoid YAML parsing issues)
              printf "Package: r8126-modules\n" > ${PKG_DIR}/DEBIAN/control
              printf "Version: 10.016.00-1\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Section: kernel\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Priority: optional\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Architecture: amd64\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Depends: linux-image-%s\n" "${KVER}" >> ${PKG_DIR}/DEBIAN/control
              printf "Maintainer: github-actions@murata-lab.net\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Description: Realtek r8126 5GbE driver module (signed)\n" >> ${PKG_DIR}/DEBIAN/control
              printf " Signed kernel module for Realtek RTL8126 5GbE network adapter.\n" >> ${PKG_DIR}/DEBIAN/control

              printf "#!/bin/bash\ndepmod -a %s || true\n" "${KVER}" > ${PKG_DIR}/DEBIAN/postinst
              chmod 755 ${PKG_DIR}/DEBIAN/postinst

              dpkg-deb --build ${PKG_DIR} /vyos/custom-packages/r8126-modules_10.016.00-1_amd64.deb

              echo "=== Phase 2 completed ==="
              ls -la /vyos/custom-packages/

              echo "============================================="
              echo "=== Phase 2.5: Re-sign VyOS Intel NIC Drivers ==="
              echo "============================================="
              # VyOS packages contain pre-signed ixgbe modules with VyOS official key
              # These are in a separate package (vyos-linux-firmware or similar)
              # We need to find and re-sign them after ISO build, or build from source

              KVER="${KERNEL_VERSION}-vyos"
              KERNEL_DIR=${WORK_DIR}/linux-${KERNEL_VERSION}

              # Download Intel ixgbe driver source and build with our kernel
              # Use kernel's built-in ixgbe source instead of external download
              # The kernel already includes ixgbe driver, we just need to build it as a module
              cd /tmp

              # Copy ixgbe source from kernel tree
              cp -r ${KERNEL_DIR}/drivers/net/ethernet/intel/ixgbe /tmp/ixgbe-src
              cd /tmp/ixgbe-src

              echo "Building ixgbe module against custom kernel..."
              make -C ${KERNEL_DIR} M=$(pwd) modules

              echo "=== Signing ixgbe module ==="
              ${KERNEL_DIR}/scripts/sign-file sha512 \
                ${KERNEL_DIR}/certs/signing_key.pem \
                ${KERNEL_DIR}/certs/signing_key.pem \
                ixgbe.ko

              if strings ixgbe.ko | grep -q "~Module signature appended~"; then
                echo "SUCCESS: ixgbe.ko is signed"
              else
                echo "WARNING: ixgbe.ko signature not detected"
              fi

              # Create .deb package for ixgbe module (to override VyOS default)
              echo "=== Creating ixgbe .deb package ==="
              IXGBE_VERSION="${KERNEL_VERSION}"
              PKG_DIR=/tmp/ixgbe-dkms
              mkdir -p ${PKG_DIR}/lib/modules/${KVER}/updates/drivers/net/ethernet/intel/ixgbe
              mkdir -p ${PKG_DIR}/DEBIAN

              cp ixgbe.ko ${PKG_DIR}/lib/modules/${KVER}/updates/drivers/net/ethernet/intel/ixgbe/

              printf "Package: ixgbe-modules-custom\n" > ${PKG_DIR}/DEBIAN/control
              printf "Version: %s-1\n" "${IXGBE_VERSION}" >> ${PKG_DIR}/DEBIAN/control
              printf "Section: kernel\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Priority: optional\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Architecture: amd64\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Provides: ixgbe-modules\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Conflicts: ixgbe-modules\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Replaces: ixgbe-modules\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Maintainer: github-actions@murata-lab.net\n" >> ${PKG_DIR}/DEBIAN/control
              printf "Description: Intel ixgbe 10GbE driver module (custom signed)\n" >> ${PKG_DIR}/DEBIAN/control
              printf " Signed kernel module for Intel X540/X550 10GbE network adapters.\n" >> ${PKG_DIR}/DEBIAN/control

              printf "#!/bin/bash\ndepmod -a %s || true\n" "${KVER}" > ${PKG_DIR}/DEBIAN/postinst
              chmod 755 ${PKG_DIR}/DEBIAN/postinst

              dpkg-deb --build ${PKG_DIR} /vyos/custom-packages/ixgbe-modules-custom_${IXGBE_VERSION}-1_amd64.deb

              # Save signed module
              cp ixgbe.ko /vyos/custom-packages/ixgbe-signed.ko

              echo "=== Phase 2.5 completed ==="
              ls -la /vyos/custom-packages/

              echo "============================================="
              echo "=== Phase 3: Build VyOS ISO with Custom Kernel ==="
              echo "============================================="

              cd /vyos

              # VyOS build system uses packages/ directory for custom packages
              # Any .deb files in packages/ will automatically replace upstream packages
              echo "Copying custom packages to packages/ directory..."
              mkdir -p /vyos/packages
              cp /vyos/custom-packages/linux-image-*.deb /vyos/packages/
              cp /vyos/custom-packages/linux-headers-*.deb /vyos/packages/ || true
              cp /vyos/custom-packages/r8126-modules_*.deb /vyos/packages/
              cp /vyos/custom-packages/ixgbe-modules-custom_*.deb /vyos/packages/

              echo "=== Packages to be included in ISO ==="
              ls -la /vyos/packages/

              # Build ISO
              # The build system will automatically pick up packages from packages/ directory
              echo "Building VyOS ISO with custom kernel..."
              sudo ./build-vyos-image \
                --architecture amd64 \
                --build-by "github-actions@murata-lab.net" \
                --build-comment "Custom ISO with r8126 driver (kernel ${KERNEL_VERSION})" \
                --version "${VYOS_VERSION}" \
                "${BUILD_TYPE}"

              echo "=== Build completed ==="
              ls -la /vyos/build/

              # Verify custom kernel is in the ISO
              echo "=== Verifying ISO contents ==="
              ISO_FILE=$(ls -1 /vyos/build/*.iso 2>/dev/null | head -1)
              if [ -n "${ISO_FILE}" ]; then
                echo "Checking ISO for custom kernel..."
                mkdir -p /tmp/iso-check
                sudo mount -o loop "${ISO_FILE}" /tmp/iso-check || true
                if [ -d "/tmp/iso-check/live" ]; then
                  echo "ISO mounted successfully"
                  ls -la /tmp/iso-check/live/ || true
                fi
                sudo umount /tmp/iso-check || true
              fi
            '

          echo "=== Final outputs ==="
          ls -la vyos-build/build/ || true
          ls -la vyos-build/custom-packages/ || true

      - name: Verify build output
        run: |
          cd vyos-build

          echo "=== Build artifacts ==="

          # Check for ISO
          if [ -d "build" ]; then
            ls -la build/
            ISO_FILE=$(ls -1 build/*.iso 2>/dev/null | head -1)
            if [ -n "${ISO_FILE}" ]; then
              echo "ISO file: ${ISO_FILE}"
              echo "Size: $(du -h "${ISO_FILE}" | cut -f1)"
              sudo sha256sum "${ISO_FILE}" | sudo tee "${ISO_FILE}.sha256"
            else
              echo "WARNING: No ISO file found in build/"
            fi
          fi

          # Check for custom packages
          if [ -d "custom-packages" ]; then
            echo ""
            echo "=== Custom packages ==="
            ls -la custom-packages/

            # Verify r8126 module is signed
            if [ -f "custom-packages/r8126-signed.ko" ]; then
              if strings custom-packages/r8126-signed.ko | grep -q "~Module signature appended~"; then
                echo "SUCCESS: r8126-signed.ko has valid signature"
              else
                echo "ERROR: r8126-signed.ko signature not found"
                exit 1
              fi
            fi

            # Show kernel config MODULE_SIG settings
            if [ -f "custom-packages/kernel-config" ]; then
              echo ""
              echo "=== MODULE_SIG settings ==="
              grep -E "MODULE_SIG" custom-packages/kernel-config | head -10
            fi
          fi

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v6
        with:
          name: vyos-custom-iso-${{ steps.vars.outputs.version }}
          path: |
            vyos-build/build/*.iso
            vyos-build/build/*.sha256
          retention-days: 7
          compression-level: 0
          if-no-files-found: warn

      - name: Upload kernel packages
        uses: actions/upload-artifact@v6
        with:
          name: vyos-kernel-packages-${{ steps.vars.outputs.version }}
          path: |
            vyos-build/custom-packages/*.deb
          retention-days: 30
          if-no-files-found: warn

      - name: Upload signed r8126 module
        uses: actions/upload-artifact@v6
        with:
          name: r8126-signed-module-${{ steps.vars.outputs.version }}
          path: |
            vyos-build/custom-packages/r8126-signed.ko
            vyos-build/custom-packages/signing_key.x509
            vyos-build/custom-packages/kernel-config
          retention-days: 30
          if-no-files-found: warn

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: build-log-${{ steps.vars.outputs.version }}
          path: |
            vyos-build/build/*.log
          retention-days: 3
          if-no-files-found: ignore

      - name: Clean up for cache
        if: always()
        run: |
          # キャッシュ保存前にビルド成果物を削除
          # (tarエラーの原因となる特殊ファイルを含む)
          echo "Cleaning up build artifacts for cache..."

          # vyos-build内のビルド成果物を削除 (.gitは保持)
          if [ -d "vyos-build" ]; then
            cd vyos-build
            # buildディレクトリとkernel-buildを削除
            rm -rf build kernel-build packages custom-packages
            # その他の生成ファイルを削除
            rm -rf *.iso *.log
            cd ..
          fi

          # ccacheの不要なtmpファイルを削除
          if [ -d "ccache-cache" ]; then
            find ccache-cache -name "*.tmp" -delete 2>/dev/null || true
          fi

          echo "Cleanup completed"
          du -sh vyos-build/.git ccache-cache kernel-cache 2>/dev/null || true

  # 失敗時の自動修正
  on-failure:
    if: failure()
    needs: [build-custom-iso]
    uses: ./.github/workflows/on-failure.yml
    secrets: inherit
