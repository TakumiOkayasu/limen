name: Build VyOS Kernel with r8126 Module

on:
  workflow_dispatch:
    inputs:
      vyos_version:
        description: "VyOS branch to build"
        required: true
        default: "current"
        type: string
      kernel_version:
        description: "Kernel version (e.g., 6.6.117)"
        required: true
        default: "6.6.117"
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          df -h

      - name: Clone vyos-build
        run: |
          git clone -b ${{ github.event.inputs.vyos_version }} --single-branch https://github.com/vyos/vyos-build.git

      - name: Build kernel and r8126 module
        run: |
          cd vyos-build
          docker run --rm --privileged \
            -v $(pwd):/vyos \
            -w /vyos \
            -e KERNEL_VERSION=${{ github.event.inputs.kernel_version }} \
            vyos/vyos-build:${{ github.event.inputs.vyos_version }} \
            bash -c '
              set -e

              echo "=== Building VyOS kernel ${KERNEL_VERSION} with MODULE_SIG_FORCE=n ==="

              cd /vyos/scripts/package-build/linux-kernel

              # Install dependencies
              sudo apt-get update
              sudo apt-get install -y curl flex bison bc libssl-dev libelf-dev libncurses-dev dwarves kmod cpio rsync debhelper fakeroot dpkg-dev

              # Download kernel source
              MAJOR_VERSION=$(echo $KERNEL_VERSION | cut -d. -f1)
              echo "Downloading kernel ${KERNEL_VERSION}..."
              curl -L -O https://cdn.kernel.org/pub/linux/kernel/v${MAJOR_VERSION}.x/linux-${KERNEL_VERSION}.tar.xz
              tar xf linux-${KERNEL_VERSION}.tar.xz
              mv linux-${KERNEL_VERSION} linux
              cd linux

              # Apply VyOS kernel config
              cp ../arch/x86/configs/vyos_defconfig arch/x86/configs/

              # Disable MODULE_SIG_FORCE (allow unsigned modules)
              echo "Patching kernel config to disable MODULE_SIG_FORCE..."
              sed -i "s/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/" arch/x86/configs/vyos_defconfig

              # Apply config
              make vyos_defconfig

              # Verify the change
              echo "Kernel config MODULE_SIG settings:"
              grep -E "MODULE_SIG" .config || true

              # Build kernel and create deb packages
              echo "Building kernel packages..."
              make -j$(nproc) bindeb-pkg LOCALVERSION=-vyos KDEB_PKGVERSION=1

              # Move deb packages to output
              mkdir -p /vyos/output
              mv /vyos/scripts/package-build/linux-kernel/*.deb /vyos/output/ || true

              # Build r8126 driver
              echo "=== Building r8126 driver ==="
              cd /tmp
              curl -L -o r8126.tar.bz2 https://github.com/openwrt/rtl8126/releases/download/10.016.00/r8126-10.016.00.tar.bz2
              tar xjf r8126.tar.bz2
              cd r8126-10.016.00/src

              # Build r8126 module
              echo "Building r8126 module..."
              make -C /vyos/scripts/package-build/linux-kernel/linux M=$(pwd) modules

              # Copy module
              cp r8126.ko /vyos/output/

              # Show module info
              echo "=== r8126 module info ==="
              modinfo r8126.ko

              echo "=== Build completed ==="
              ls -la /vyos/output/
            '

      - name: Upload kernel packages
        uses: actions/upload-artifact@v6
        with:
          name: vyos-kernel-packages
          path: vyos-build/output/*.deb
          retention-days: 30

      - name: Upload r8126 module
        uses: actions/upload-artifact@v6
        with:
          name: r8126-module
          path: vyos-build/output/r8126.ko
          retention-days: 30
