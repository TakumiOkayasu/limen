name: Build VyOS Kernel with Signed r8126 Module

on:
  workflow_dispatch:
    inputs:
      vyos_version:
        description: "VyOS branch to build"
        required: true
        default: "current"
        type: string
      kernel_version:
        description: "Kernel version (e.g., 6.6.117)"
        required: true
        default: "6.6.117"
        type: string
  pull_request:
    paths:
      - ".github/workflows/build-vyos.yml"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          df -h

      - name: Clone vyos-build
        run: |
          VERSION="${{ github.event.inputs.vyos_version || 'current' }}"
          git clone -b "$VERSION" --single-branch https://github.com/vyos/vyos-build.git

      - name: Build kernel and signed r8126 module
        run: |
          cd vyos-build
          VERSION="${{ github.event.inputs.vyos_version || 'current' }}"
          KERNEL_VERSION="${{ github.event.inputs.kernel_version || '6.6.117' }}"

          docker run --rm --privileged \
            -v $(pwd):/vyos \
            -w /vyos \
            -e KERNEL_VERSION="$KERNEL_VERSION" \
            vyos/vyos-build:${VERSION} \
            bash -c '
              set -e

              echo "=== Building VyOS kernel with signed r8126 module ==="
              echo "Kernel version: ${KERNEL_VERSION}"

              # Install build dependencies (from successful CI run 20783576119)
              sudo apt-get update
              sudo apt-get install -y curl flex bison bc libssl-dev libelf-dev \
                libncurses-dev dwarves kmod cpio rsync debhelper fakeroot dpkg-dev

              WORK_DIR=/vyos/kernel-build
              mkdir -p ${WORK_DIR}
              cd ${WORK_DIR}

              echo "=== Step 1: Getting VyOS kernel config ==="
              # VyOS defconfig is in scripts/package-build/linux-kernel/
              DEFCONFIG_PATH="/vyos/scripts/package-build/linux-kernel/arch/x86/configs/vyos_defconfig"

              MAJOR_VERSION=$(echo $KERNEL_VERSION | cut -d. -f1)
              echo "Downloading kernel ${KERNEL_VERSION}..."
              curl -L -O https://cdn.kernel.org/pub/linux/kernel/v${MAJOR_VERSION}.x/linux-${KERNEL_VERSION}.tar.xz
              tar xf linux-${KERNEL_VERSION}.tar.xz
              cd linux-${KERNEL_VERSION}

              if [ -f "${DEFCONFIG_PATH}" ]; then
                echo "Using VyOS defconfig from scripts/package-build..."
                cp "${DEFCONFIG_PATH}" .config
                make olddefconfig
              else
                echo "VyOS defconfig not found at ${DEFCONFIG_PATH}, searching..."
                find /vyos -name "vyos_defconfig" -type f 2>/dev/null || true
                echo "ERROR: VyOS defconfig is required for proper MODULE_SIG settings"
                exit 1
              fi

              echo "=== Step 2: Generating module signing keys ==="
              mkdir -p certs

              # x509.genkey content (base64 encoded to avoid YAML issues)
              echo "W3JlcV0KZGVmYXVsdF9iaXRzID0gNDA5NgpkaXN0aW5ndWlzaGVkX25hbWUgPSByZXFfZGlzdGluZ3Vpc2hlZF9uYW1lCnByb21wdCA9IG5vCng1MDlfZXh0ZW5zaW9ucyA9IHYzX2NhCgpbcmVxX2Rpc3Rpbmd1aXNoZWRfbmFtZV0KQ04gPSBWeU9TIE1vZHVsZSBTaWduaW5nIEtleQplbWFpbEFkZHJlc3MgPSBidWlsZEB2eW9zLmxvY2FsCgpbdjNfY2FdCmJhc2ljQ29uc3RyYWludHM9Y3JpdGljYWwsQ0E6RkFMU0UKa2V5VXNhZ2U9ZGlnaXRhbFNpZ25hdHVyZQpzdWJqZWN0S2V5SWRlbnRpZmllcj1oYXNoCmF1dGhvcml0eUtleUlkZW50aWZpZXI9a2V5aWQK" | base64 -d > x509.genkey

              openssl req -new -nodes -utf8 -sha512 -days 36500 \
                -batch -x509 -config x509.genkey \
                -outform PEM -out certs/signing_key.pem \
                -keyout certs/signing_key.pem

              # Set signing key path and ensure all modules are signed
              ./scripts/config --set-str MODULE_SIG_KEY "certs/signing_key.pem"
              ./scripts/config --set-str SYSTEM_TRUSTED_KEYS ""
              # Ensure MODULE_SIG_ALL=y so all modules (including =m) are signed during build
              ./scripts/config --enable MODULE_SIG_ALL
              make olddefconfig

              echo "=== Verifying MODULE_SIG settings ==="
              grep -E "MODULE_SIG|SYSTEM_TRUSTED" .config || true
              if ! grep -q "CONFIG_MODULE_SIG=y" .config; then
                echo "ERROR: CONFIG_MODULE_SIG is not enabled!"
                exit 1
              fi
              if ! grep -q "CONFIG_MODULE_SIG_ALL=y" .config; then
                echo "ERROR: CONFIG_MODULE_SIG_ALL is not enabled - loadable modules will not be signed!"
                exit 1
              fi
              echo "MODULE_SIG is properly configured (including MODULE_SIG_ALL)."

              echo "=== Verifying critical VyOS kernel options ==="
              echo "Checking nftables support..."
              REQUIRED_OPTS="
                CONFIG_NETFILTER=y
                CONFIG_NF_TABLES
                CONFIG_NF_CONNTRACK
                CONFIG_NF_NAT
                CONFIG_NFT_NAT
                CONFIG_NFT_MASQ
                CONFIG_NFT_CT
                CONFIG_NETFILTER_XTABLES
              "
              MISSING=""
              for opt in $REQUIRED_OPTS; do
                base_opt=$(echo "$opt" | cut -d= -f1)
                if ! grep -q "^${base_opt}=" .config; then
                  echo "WARNING: ${base_opt} not found in config"
                  MISSING="${MISSING} ${base_opt}"
                else
                  grep "^${base_opt}=" .config
                fi
              done
              if [ -n "$MISSING" ]; then
                echo "ERROR: Missing critical options:${MISSING}"
                echo "These are required for VyOS firewall/NAT to work"
                exit 1
              fi
              echo "All critical VyOS kernel options are present."

              echo "=== Step 3: Building kernel ==="
              # Initialize git repository (required for deb-pkg)
              # deb-pkg requires git to determine version info
              git init
              git config user.email "build@vyos.local"
              git config user.name "VyOS Kernel Builder"
              git add -A
              git commit -m "Initial commit for kernel build"

              # Use deb-pkg to include modules (not just bindeb-pkg)
              # Note: KDEB_PKGVERSION must include revision (e.g., 1-1) for quilt format
              make -j$(nproc) deb-pkg LOCALVERSION=-vyos KDEB_PKGVERSION=1-1

              mkdir -p /vyos/output
              mv ../*.deb /vyos/output/ || true

              echo "=== Step 4: Building r8126 driver ==="
              cd /tmp
              curl -L -o r8126.tar.bz2 https://github.com/openwrt/rtl8126/releases/download/10.016.00/r8126-10.016.00.tar.bz2
              tar xjf r8126.tar.bz2
              cd r8126-10.016.00/src

              KERNEL_DIR=${WORK_DIR}/linux-${KERNEL_VERSION}
              echo "Building r8126 module against ${KERNEL_DIR}..."
              make -C ${KERNEL_DIR} M=$(pwd) modules

              echo "=== Step 5: Signing r8126 module ==="
              ${KERNEL_DIR}/scripts/sign-file sha512 \
                ${KERNEL_DIR}/certs/signing_key.pem \
                ${KERNEL_DIR}/certs/signing_key.pem \
                r8126.ko

              echo "Verifying module signature..."
              if strings r8126.ko | grep -q "~Module signature appended~"; then
                echo "SUCCESS: r8126.ko is signed"
              else
                echo "WARNING: Module signature not detected"
              fi

              echo "=== Module info ==="
              modinfo r8126.ko || true

              echo "=== Step 6: Collecting outputs ==="
              cp r8126.ko /vyos/output/r8126-signed.ko
              openssl x509 -in ${KERNEL_DIR}/certs/signing_key.pem -outform DER -out /vyos/output/signing_key.x509
              cp ${KERNEL_DIR}/.config /vyos/output/kernel-config

              echo "=== Build completed ==="
              ls -la /vyos/output/

              echo ""
              echo "=== Verification ==="
              echo "MODULE_SIG settings in kernel:"
              grep -E "MODULE_SIG" /vyos/output/kernel-config | head -10

              echo ""
              echo "=== Verifying nftables modules in kernel package ==="
              echo "Checking critical kernel options are set:"
              grep -E "^CONFIG_NF_TABLES=" /vyos/output/kernel-config
              grep -E "^CONFIG_NETFILTER=" /vyos/output/kernel-config
              grep -E "^CONFIG_NFT_" /vyos/output/kernel-config | head -20

              echo ""
              echo "=== Listing generated deb packages ==="
              ls -la /vyos/output/*.deb
            '

      - name: Verify outputs
        run: |
          echo "=== Checking outputs ==="
          ls -la vyos-build/output/

          echo ""
          echo "=== Checking if module is signed ==="
          if strings vyos-build/output/r8126-signed.ko | grep -q "~Module signature appended~"; then
            echo "r8126-signed.ko has valid signature"
          else
            echo "r8126-signed.ko signature not found"
            exit 1
          fi

          echo ""
          echo "=== MODULE_SIG settings ==="
          grep -E "MODULE_SIG" vyos-build/output/kernel-config || true

          echo ""
          echo "=== Verifying nftables support in kernel config ==="
          if grep -q "^CONFIG_NF_TABLES=m" vyos-build/output/kernel-config || \
             grep -q "^CONFIG_NF_TABLES=y" vyos-build/output/kernel-config; then
            echo "SUCCESS: nftables support is enabled"
            grep "^CONFIG_NF_TABLES=" vyos-build/output/kernel-config
          else
            echo "ERROR: nftables support is NOT enabled - VyOS firewall will not work!"
            exit 1
          fi

          echo ""
          echo "=== Checking for critical netfilter modules ==="
          for opt in CONFIG_NETFILTER CONFIG_NF_CONNTRACK CONFIG_NF_NAT; do
            if grep -q "^${opt}=" vyos-build/output/kernel-config; then
              grep "^${opt}=" vyos-build/output/kernel-config
            else
              echo "WARNING: ${opt} not found"
            fi
          done

      - name: Upload kernel packages
        uses: actions/upload-artifact@v6
        with:
          name: vyos-kernel-packages
          path: |
            vyos-build/output/*.deb
          retention-days: 30

      - name: Upload signed r8126 module
        uses: actions/upload-artifact@v6
        with:
          name: r8126-signed-module
          path: |
            vyos-build/output/r8126-signed.ko
            vyos-build/output/signing_key.x509
          retention-days: 30

      - name: Upload kernel config
        uses: actions/upload-artifact@v6
        with:
          name: kernel-config
          path: vyos-build/output/kernel-config
          retention-days: 30

  # 失敗時の自動修正
  on-failure:
    if: failure()
    needs: [build]
    uses: ./.github/workflows/on-failure.yml
    secrets: inherit
