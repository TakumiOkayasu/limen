name: Build VyOS Kernel with Signed r8126 Module

on:
  workflow_dispatch:
    inputs:
      vyos_version:
        description: "VyOS branch to build"
        required: true
        default: "current"
        type: string
      kernel_version:
        description: "Kernel version (e.g., 6.6.75)"
        required: true
        default: "6.6.75"
        type: string
  pull_request:
    paths:
      - ".github/workflows/build-vyos.yml"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          df -h

      - name: Clone vyos-build
        run: |
          VERSION="${{ github.event.inputs.vyos_version || 'current' }}"
          git clone -b "$VERSION" --single-branch https://github.com/vyos/vyos-build.git

      - name: Build kernel and signed r8126 module
        run: |
          cd vyos-build
          VERSION="${{ github.event.inputs.vyos_version || 'current' }}"
          KERNEL_VERSION="${{ github.event.inputs.kernel_version || '6.6.75' }}"

          docker run --rm --privileged \
            -v $(pwd):/vyos \
            -w /vyos \
            -e KERNEL_VERSION="$KERNEL_VERSION" \
            vyos/vyos-build:${VERSION} \
            bash -c '
              set -e

              echo "=== Building VyOS kernel with signed r8126 module ==="
              echo "Kernel version: ${KERNEL_VERSION}"

              # Create work directory
              WORK_DIR=/vyos/kernel-build
              mkdir -p ${WORK_DIR}
              cd ${WORK_DIR}

              # Step 1: Get VyOS kernel config
              echo "=== Step 1: Getting VyOS kernel config ==="
              git clone https://github.com/vyos/vyos-build-kernel.git || true

              # Download kernel source
              MAJOR_VERSION=$(echo $KERNEL_VERSION | cut -d. -f1)
              echo "Downloading kernel ${KERNEL_VERSION}..."
              curl -L -O https://cdn.kernel.org/pub/linux/kernel/v${MAJOR_VERSION}.x/linux-${KERNEL_VERSION}.tar.xz
              tar xf linux-${KERNEL_VERSION}.tar.xz
              cd linux-${KERNEL_VERSION}

              # Apply VyOS config
              if [ -f "../vyos-build-kernel/x86_64_vyos_defconfig" ]; then
                echo "Using VyOS defconfig..."
                cp ../vyos-build-kernel/x86_64_vyos_defconfig .config
                make olddefconfig
              else
                echo "VyOS defconfig not found, using default..."
                make defconfig
              fi

              # Step 2: Generate signing keys
              echo "=== Step 2: Generating module signing keys ==="
              mkdir -p certs
              cat > x509.genkey << EOF
[ req ]
default_bits = 4096
distinguished_name = req_distinguished_name
prompt = no
x509_extensions = v3_ca

[ req_distinguished_name ]
CN = VyOS Module Signing Key
emailAddress = build@vyos.local

[ v3_ca ]
basicConstraints=critical,CA:FALSE
keyUsage=digitalSignature
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid
EOF
              openssl req -new -nodes -utf8 -sha512 -days 36500 \
                -batch -x509 -config x509.genkey \
                -outform PEM -out certs/signing_key.pem \
                -keyout certs/signing_key.pem

              # Update config to use the key
              ./scripts/config --set-str MODULE_SIG_KEY "certs/signing_key.pem"
              ./scripts/config --set-str SYSTEM_TRUSTED_KEYS ""
              make olddefconfig

              # Show MODULE_SIG settings
              echo "MODULE_SIG settings:"
              grep -E "MODULE_SIG|SYSTEM_TRUSTED" .config || true

              # Step 3: Build kernel
              echo "=== Step 3: Building kernel ==="
              make -j$(nproc) bindeb-pkg LOCALVERSION=-vyos KDEB_PKGVERSION=1

              # Move kernel debs to output
              mkdir -p /vyos/output
              mv ../*.deb /vyos/output/ || true

              # Step 4: Build r8126 driver
              echo "=== Step 4: Building r8126 driver ==="
              cd /tmp
              curl -L -o r8126.tar.bz2 https://github.com/openwrt/rtl8126/releases/download/10.016.00/r8126-10.016.00.tar.bz2
              tar xjf r8126.tar.bz2
              cd r8126-10.016.00/src

              KERNEL_DIR=${WORK_DIR}/linux-${KERNEL_VERSION}
              echo "Building r8126 module against ${KERNEL_DIR}..."
              make -C ${KERNEL_DIR} M=$(pwd) modules

              # Step 5: Sign the module
              echo "=== Step 5: Signing r8126 module ==="
              ${KERNEL_DIR}/scripts/sign-file sha512 \
                ${KERNEL_DIR}/certs/signing_key.pem \
                ${KERNEL_DIR}/certs/signing_key.pem \
                r8126.ko

              # Verify signature
              echo "Verifying module signature..."
              if strings r8126.ko | grep -q "~Module signature appended~"; then
                echo "SUCCESS: r8126.ko is signed"
              else
                echo "WARNING: Module signature not detected"
              fi

              # Show module info
              echo "=== Module info ==="
              modinfo r8126.ko || true

              # Copy outputs
              echo "=== Step 6: Collecting outputs ==="
              cp r8126.ko /vyos/output/r8126-signed.ko

              # Save the signing key (public part only for verification)
              openssl x509 -in ${KERNEL_DIR}/certs/signing_key.pem -outform DER -out /vyos/output/signing_key.x509

              # Save kernel config for verification
              cp ${KERNEL_DIR}/.config /vyos/output/kernel-config

              echo "=== Build completed ==="
              ls -la /vyos/output/

              echo ""
              echo "=== Verification ==="
              echo "MODULE_SIG settings in kernel:"
              grep -E "MODULE_SIG" /vyos/output/kernel-config | head -10
            '

      - name: Verify outputs
        run: |
          echo "=== Checking outputs ==="
          ls -la vyos-build/output/

          echo ""
          echo "=== Checking if module is signed ==="
          if strings vyos-build/output/r8126-signed.ko | grep -q "~Module signature appended~"; then
            echo "âœ… r8126-signed.ko has valid signature"
          else
            echo "âŒ r8126-signed.ko signature not found"
            exit 1
          fi

          echo ""
          echo "=== MODULE_SIG settings ==="
          grep -E "MODULE_SIG" vyos-build/output/kernel-config || true

      - name: Upload kernel packages
        uses: actions/upload-artifact@v6
        with:
          name: vyos-kernel-packages
          path: |
            vyos-build/output/*.deb
          retention-days: 30

      - name: Upload signed r8126 module
        uses: actions/upload-artifact@v6
        with:
          name: r8126-signed-module
          path: |
            vyos-build/output/r8126-signed.ko
            vyos-build/output/signing_key.x509
          retention-days: 30

      - name: Upload kernel config
        uses: actions/upload-artifact@v6
        with:
          name: kernel-config
          path: vyos-build/output/kernel-config
          retention-days: 30
