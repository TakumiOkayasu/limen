name: Build VyOS Custom ISO

# VyOS ISOビルド
# 参考:
# - https://docs.vyos.io/en/latest/contributing/build-vyos.html
# - https://github.com/vyos/vyos-build

on:
  workflow_dispatch:
    inputs:
      vyos_branch:
        description: "VyOS branch (current, sagitta, circinus)"
        required: true
        default: "current"
        type: choice
        options:
          - current
          - sagitta
          - circinus
      build_type:
        description: "Build type"
        required: true
        default: "generic"
        type: choice
        options:
          - generic
          - cloud-init
  pull_request:
    paths:
      - ".github/workflows/build-vyos-iso.yml"

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  build-iso:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          echo "=== Before cleanup ==="
          df -h

          # 不要なツールを削除してディスク容量を確保
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af

          echo "=== After cleanup ==="
          df -h

      - name: Set build variables
        id: vars
        run: |
          BRANCH="${{ github.event.inputs.vyos_branch || 'current' }}"
          BUILD_DATE=$(date -u +%Y%m%d%H%M)
          VERSION="custom-${BUILD_DATE}"

          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT

          echo "Branch: ${BRANCH}"
          echo "Version: ${VERSION}"

      - name: Cache vyos-build repository
        id: cache-vyos-build
        uses: actions/cache@v4
        with:
          path: vyos-build
          key: vyos-build-${{ steps.vars.outputs.branch }}-${{ github.run_id }}
          restore-keys: |
            vyos-build-${{ steps.vars.outputs.branch }}-

      - name: Clone vyos-build repository
        if: steps.cache-vyos-build.outputs.cache-hit != 'true'
        run: |
          BRANCH="${{ steps.vars.outputs.branch }}"
          echo "Cloning vyos-build branch: ${BRANCH}"

          git clone -b "${BRANCH}" --single-branch --depth 1 \
            https://github.com/vyos/vyos-build.git

          cd vyos-build
          echo "=== Repository info ==="
          git log -1 --oneline
          ls -la

      - name: Update vyos-build repository
        if: steps.cache-vyos-build.outputs.cache-hit == 'true'
        run: |
          cd vyos-build
          git fetch origin
          git reset --hard origin/${{ steps.vars.outputs.branch }}
          echo "=== Repository info (updated) ==="
          git log -1 --oneline

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker image
        id: cache-docker
        uses: actions/cache@v4
        with:
          path: /tmp/vyos-docker-image.tar
          key: vyos-docker-${{ steps.vars.outputs.branch }}-${{ hashFiles('.github/workflows/build-vyos-iso.yml') }}
          restore-keys: |
            vyos-docker-${{ steps.vars.outputs.branch }}-

      - name: Load cached Docker image
        if: steps.cache-docker.outputs.cache-hit == 'true'
        run: |
          docker load -i /tmp/vyos-docker-image.tar
          docker images

      - name: Pull VyOS build container
        if: steps.cache-docker.outputs.cache-hit != 'true'
        run: |
          BRANCH="${{ steps.vars.outputs.branch }}"
          echo "Pulling Docker image: vyos/vyos-build:${BRANCH}"

          docker pull "vyos/vyos-build:${BRANCH}"
          docker images

          # キャッシュ用に保存
          docker save "vyos/vyos-build:${BRANCH}" -o /tmp/vyos-docker-image.tar

      - name: Build VyOS ISO
        run: |
          cd vyos-build

          BRANCH="${{ steps.vars.outputs.branch }}"
          VERSION="${{ steps.vars.outputs.version }}"
          BUILD_TYPE="${{ github.event.inputs.build_type || 'generic' }}"

          echo "=== Build Configuration ==="
          echo "Branch: ${BRANCH}"
          echo "Version: ${VERSION}"
          echo "Build Type: ${BUILD_TYPE}"
          echo "=========================="

          # VyOS ISOビルド
          # --privileged: squashfs作成に必要
          # 参考: https://docs.vyos.io/en/latest/contributing/build-vyos.html
          docker run --rm --privileged \
            -v "$(pwd):/vyos" \
            -w /vyos \
            -e VYOS_VERSION="${VERSION}" \
            "vyos/vyos-build:${BRANCH}" \
            sudo ./build-vyos-image \
              --architecture amd64 \
              --build-by "github-actions@murata-lab.net" \
              --build-comment "Custom ISO built by GitHub Actions" \
              --version "${VERSION}" \
              "${BUILD_TYPE}"

          echo "=== Build completed ==="
          ls -la build/

      - name: Verify build output
        run: |
          cd vyos-build/build

          echo "=== Build artifacts ==="
          ls -la

          # ISOファイルを確認
          ISO_FILE=$(ls -1 *.iso 2>/dev/null | head -1)
          if [ -z "${ISO_FILE}" ]; then
            echo "ERROR: No ISO file found!"
            exit 1
          fi

          echo "ISO file: ${ISO_FILE}"
          echo "Size: $(du -h "${ISO_FILE}" | cut -f1)"

          # チェックサム生成 (rootで作成されたファイルのためsudo使用)
          sudo sha256sum "${ISO_FILE}" | sudo tee "${ISO_FILE}.sha256"

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v6
        with:
          name: vyos-custom-iso-${{ steps.vars.outputs.version }}
          path: |
            vyos-build/build/*.iso
            vyos-build/build/*.sha256
          retention-days: 7
          compression-level: 0  # ISOは既に圧縮されているため

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: build-log-${{ steps.vars.outputs.version }}
          path: |
            vyos-build/build/*.log
          retention-days: 3
          if-no-files-found: ignore

  # 失敗時の自動修正
  on-failure:
    if: failure()
    needs: [build-iso]
    uses: ./.github/workflows/on-failure.yml
    secrets: inherit
