# 作業ログ 2026-01-08

## 完了したタスク

### 1. VyOS再インストール・復旧
- カーネル更新失敗 (2026-01-07) からの復旧
- VyOS再インストール完了
- SSH接続復旧

### 2. IPv6疎通復旧
- **問題**: NGNゲートウェイのMACアドレスを間違えていた
  - 誤: `F0:F8:4A:67:58:00` (これはWXRのMAC)
  - 正: `A4:11:BB:7D:EE:11` (NGNゲートウェイ)
- **解決**: `sudo rdisc6 eth1` で正しいゲートウェイを発見
- **設定修正**: `set protocols static route6 ::/0 next-hop fe80::a611:bbff:fe7d:ee11 interface eth1`
- IPv6疎通確認完了 (`ping6 google.com` 成功)

### 3. CI修正
- `build-vyos.yml` の `.config` パス修正
- r8126ビルド後のカレントディレクトリ問題を解決
- CI成功、成果物DL済み (ユーザーがダウンロード)

### 4. ドキュメント整理
- CLAUDE.mdをシンプル化
- `docs/troubleshooting-ipv6.md` 新規作成
- `docs/reference.md` に機器MACアドレス一覧追加
- Git操作ルール追加 (ブランチ作成はAIの仕事)
- 作業の安全ルール追加 (バックアップ必須)

---

## 進行中のタスク

### IPv4構成 (MAP-E実装)

**決定事項**:
- 案E採用: VyOS自身がMAP-E CEになる
- WXRはAPモードで使用
- 10GbE回線を100%活用

**MAP-Eパラメータ** (reference.mdに記載):
```
CE: 2404:7a82:4d02:4100:85:d10d:200:4100
BR: 2001:260:700:1::1:275
IPv4: 133.209.13.2
ポート: 5136-5151 (16ポート)
```

**計画書**: `docs/phase4-mape-vyos.md` 作成済み

**バックアップ**: `/config/backup-20260108-mape.txt` 取得済み

**次のステップ**:
1. CI成果物 (カーネル) のconfig検証 (Dockerで)
2. MAP-E実装開始

---

## 未完了・保留

### カーネル成果物の検証
- CI成功、成果物はユーザーがDL済み
- **パス未確認** - 次回確認必要
- Dockerでconfig検証 (`MODULE_SIG_FORCE=n` 確認)
- 本番適用前にVMでフルテスト推奨

### 代替案 (案H): WXRへプレフィックス再委譲
- MAP-Eが複雑すぎる場合の代替
- VyOSがDHCPv6サーバーとなりWXRに/60を委譲
- `docs/phase4-mape-vyos.md` に概念記載

---

## 現在のブランチ

`feat/ipv4-routing` - MAP-E実装用ブランチ

**未コミットの変更**:
- `docs/phase4-mape-vyos.md` (新規)
- `CLAUDE.md` (安全ルール追加)

---

## 重要な学び (今日判明したこと)

1. **NGNゲートウェイの確認方法**: `sudo rdisc6 eth1`
2. **WXRのMAC** (`F0:F8:4A:67:58:00`) はNGNゲートウェイではない
3. **Dockerではカーネル動作検証不可** - ホストカーネル共有のため
4. **VyOSのdhcp6c.service**は存在しない - `commit`またはインターフェース再起動で対応
5. **`ipv6 address`空ブロック問題** - `delete interfaces ethernet eth1 ipv6 address`で解決

---

## 次回やること

1. CI成果物のパスを確認
2. Dockerでkernel config検証 (`MODULE_SIG_FORCE=n`)
3. MAP-E実装 (Step 1からスタート)
4. コミット・PR作成

---

## X540-T2 オーバーヒート問題 (完成後に対応)

### 発生状況
- **症状**: SSHとpingが突然通らなくなった
- **原因**: Intel X540-T2 NICがオーバーヒートでeth1/eth2両方が停止
- **カーネルログ**:
  ```
  ixgbe 0000:01:00.1 eth1: Network adapter has been stopped because it has over heated.
  ixgbe 0000:01:00.0 eth2: Network adapter has been stopped because it has over heated.
  ```

### 現状の冷却
- 内蔵ファンのみ
- NICにヒートシンクなし

### TODO: 熱対策（プロジェクト完成後に対応）

1. **ヒートシンク追加（推奨・最優先）**
   - X540-T2用の汎用ヒートシンク（40x40mm程度）
   - サーマルテープ付きで500〜1500円程度

2. **エアフロー改善**
   - NIC直上にケースファン追加
   - PCIeスロットファン（ブロワー型）も選択肢

3. **長期的検討: NIC交換**
   - Intel X710-T2L（低発熱、X540より省電力）
   - X540-T2は10GbE NICの中でも特に発熱が大きい

### 温度監視コマンド（再起動後に使用）
```bash
sudo sensors
# または
cat /sys/class/hwmon/hwmon*/temp1_input
```
