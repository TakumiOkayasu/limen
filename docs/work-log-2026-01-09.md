# 作業ログ: 2026-01-09 MAP-E実装

## 概要

VyOSでMAP-Eトンネルを構築し、IPv4接続を実現する作業を実施。トンネル構築とNAPT設定まで完了したが、まだ疎通確認できていない。

---

## 環境状態 (作業終了時点)

| 機器 | 状態 |
|------|------|
| VyOS | SSH接続中、mapeトンネルUP |
| WXR | APモード (MAP-E機能なし) |
| IPv4デフォルトルート | `dev mape` (トンネル経由) |

---

## 成功したこと

### 1. MAP-Eパラメータの取得・保存

WXRから取得したパラメータを `claude_tmp/mape-params.txt` に保存 (gitignore済み):

```
BR_ADDRESS=2404:9200:225:100::64
CE_ADDRESS=2404:7a82:4d02:4100:85:d10d:200:4100
IPV4_ADDRESS=133.209.13.2
PORT_RANGES="5136-5151,9232-9247,13328-13343,..." (15ブロック×16ポート=240ポート)
IPV6_PREFIX=2404:7a82:4d02:4100::/56
```

### 2. MAP-Eトンネル (ip6tnl) の作成

```bash
# 作成コマンド
sudo ip -6 tunnel add mape mode ip4ip6 \
    remote 2404:9200:225:100::64 \
    local 2404:7a82:4d02:4100:85:d10d:200:4100 \
    dev eth1

sudo ip addr add 133.209.13.2/32 dev mape
sudo ip link set mape up
sudo ip route add default dev mape
```

**確認済み:**
- トンネルインターフェース: UP
- IPアドレス: 133.209.13.2/32 設定済み
- パケット送信: eth1からBRへ正しく送信されている (tcpdump確認)

### 3. IPv6ルーティング修正

BRアドレスへの直接ルートが問題だったため修正:

```bash
# 問題: VyOSがBRをローカルで探していた
# ip -6 route get 2404:9200:225:100::64
# → dev eth1 (viaなし、neighbor FAILEDになる)

# 解決: 明示的にゲートウェイ経由にする
sudo ip -6 route del 2404:9200:225:100::64/128 dev eth1
sudo ip -6 route add 2404:9200:225:100::64/128 via fe80::a611:bbff:fe7d:ee11 dev eth1

# 確認
# ip -6 route get 2404:9200:225:100::64
# → via fe80::a611:bbff:fe7d:ee11 dev eth1 (正しい)
```

### 4. NAPT設定 (VyOS nftables)

MAP-Eではソースポートを許可範囲内に変換する必要がある:

```bash
# VyOS configureモードで設定
set nat source rule 200 outbound-interface name 'mape'
set nat source rule 200 source address '192.168.1.0/24'
set nat source rule 200 protocol 'tcp_udp'
set nat source rule 200 translation address '133.209.13.2'
set nat source rule 200 translation port '5136-5151'

set nat source rule 210 outbound-interface name 'mape'
set nat source rule 210 protocol 'tcp_udp'
set nat source rule 210 translation address '133.209.13.2'
set nat source rule 210 translation port '5136-5151'

commit
```

- rule 200: LANクライアント (192.168.1.0/24) からのトラフィック
- rule 210: VyOS自体からのトラフィック

---

## まだできていないこと

### 1. IPv4疎通が確認できない

**症状:**
- ping 8.8.8.8 → 100% packet loss
- dig @8.8.8.8 google.com → timed out

**tcpdumpで確認した状況:**
- 送信: eth1からBRへパケットが出ている ✓
- 受信: 戻りパケットが一切来ない ✗

### 2. 考えられる原因

1. **BR側で認証されていない可能性**
   - DHCPv6でS46オプション (MAP-Eルール) を取得していない
   - BIGLOBEのBRがこのCEを正規顧客として認識していない可能性

2. **BRアドレスの非対称性**
   - 送信先: 2404:9200:225:100::64
   - 以前の調査で応答元: 2001:260:700:1::1:275 (異なるアドレス)
   - 現在のトンネル設定では異なるアドレスからの応答を受け取れない

3. **ポート範囲の問題**
   - 現在16ポートのみ設定 (5136-5151)
   - VyOSは複数範囲を1ルールで指定できない

---

## 次回やること

### 優先度高

1. **BR応答アドレスの対応**
   ```bash
   # 方法A: remote anyでトンネル作成し直し
   sudo ip -6 tunnel del mape
   sudo ip -6 tunnel add mape mode ip4ip6 \
       remote any \
       local 2404:7a82:4d02:4100:85:d10d:200:4100 \
       dev eth1

   # 方法B: ip6tnl0 (フォールバック) の活用
   # remote any のトンネルが存在すれば、任意のアドレスからの応答を受け取れる
   ```

2. **DHCPv6 S46オプションの調査**
   - VyOSのwide-dhcpv6がS46に対応しているか確認
   - 対応していない場合、代替手段を検討

### 優先度中

3. **全ポート範囲のNAPT設定**
   - 現在1ブロック(16ポート)のみ
   - 15ブロック分のルールを追加する必要あり

4. **設定の永続化**
   - 現在のトンネル設定はreboot後に消える
   - VyOS configまたはスクリプトで永続化

---

## 参考: WXRでMAP-Eが動作していた時との差

| 項目 | WXR (動作) | VyOS (未動作) |
|------|------------|---------------|
| MAP-Eパラメータ取得 | DHCPv6 S46オプション | 手動設定 |
| BR認証 | ISP側で認証済み | 未認証? |
| NAPT | 自動設定 | 手動設定 (一部のみ) |
| 戻りパケット処理 | 自動 | 要確認 |

---

## 関連ファイル

- `claude_tmp/mape-params.txt` - MAP-Eパラメータ (gitignore済み)
- `docs/report-biglobe-ipv6-wxr.md` - BIGLOBE IPv6オプション調査レポート
- `docs/phase4-mape-vyos.md` - MAP-E実装計画 (作成予定)

---

## コマンドメモ

### トンネル確認
```bash
ip -6 tunnel show
ip addr show mape
ip link show mape
ip route show
ip -6 route show dev eth1
```

### tcpdump
```bash
# MAP-Eパケット確認 (IPv4 in IPv6)
sudo tcpdump -i eth1 -n 'ip6 proto 4'

# 特定BR宛
sudo tcpdump -i eth1 -n host 2404:9200:225:100::64

# mapeインターフェース
sudo tcpdump -i mape -n icmp
```

### NAT確認
```bash
sudo nft list table ip vyos_nat
```
