# 作業ログ 2026-01-13

## r8126ドライバ検証

### 結論

カスタムカーネルでnftablesモジュールが動作せず、VyOSの設定システムが壊れた。

### 原因

1. `CONFIG_NF_TABLES=m` (モジュール) だが、ビルド時に署名されていなかった
2. `MODULE_SIG_ALL=y` が設定されていなかったため、`=m`のモジュールが未署名
3. VyOSは `MODULE_SIG_FORCE=y` なので、未署名モジュールはロード不可

### エラー内容

```
mnl.c:61: Unable to initialize Netlink socket: Protocol not supported
```

VyOSの `configure` → `commit` 時に以下のエラー:

```
ProcessLookupError: [Errno 3] failed to run command: None nft -a list chain raw VYOS_TCP_MSS
```

---

## CI修正

### PR

`fix/ci-kernel-nftables-support` (マージ済み)

### 変更内容

1. **MODULE_SIG_ALL=y を有効化**
   - 全モジュール (`=m`) をビルド時に自動署名

2. **nftables関連オプションの検証を追加**
   - CONFIG_NETFILTER
   - CONFIG_NF_TABLES
   - CONFIG_NF_CONNTRACK
   - CONFIG_NF_NAT
   - CONFIG_NFT_NAT
   - CONFIG_NFT_MASQ
   - CONFIG_NFT_CT
   - CONFIG_NETFILTER_XTABLES

3. **ビルドコマンド変更**
   - `bindeb-pkg` → `deb-pkg` (モジュール含むフルパッケージ生成)

---

## 次回の検証手順

1. 新しいCIでカーネルをビルド (GitHub Actions)
2. VM環境で以下を確認:
   - `sudo nft list tables` が動作するか
   - `configure` → `commit` が成功するか
   - SSHが正常に動作するか
3. 成功したら本番VyOSに適用

---

## 参考情報

### VyOS defconfigの場所

```
vyos-build/scripts/package-build/linux-kernel/arch/x86/configs/vyos_defconfig
```

### nftables必須カーネルオプション

| オプション | 値 | 用途 |
|-----------|-----|------|
| CONFIG_NETFILTER | y | Netfilterフレームワーク |
| CONFIG_NF_TABLES | m | nftablesコア |
| CONFIG_NF_CONNTRACK | m | 接続追跡 |
| CONFIG_NF_NAT | m | NAT |
| CONFIG_NFT_NAT | m | nftables NAT |
| CONFIG_NFT_MASQ | m | マスカレード |
| CONFIG_NFT_CT | m | 接続追跡 |
| CONFIG_NETFILTER_XTABLES | m | xtables互換 |

### モジュール署名関連

| オプション | 値 | 用途 |
|-----------|-----|------|
| CONFIG_MODULE_SIG | y | モジュール署名有効 |
| CONFIG_MODULE_SIG_FORCE | y | 署名必須 (VyOSデフォルト) |
| CONFIG_MODULE_SIG_ALL | y | ビルド時に全モジュール署名 |
