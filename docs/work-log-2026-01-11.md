# 作業ログ: 2026-01-11 MAP-E再試行とWXR復旧

## 概要

MAP-Eトンネルのデバッグを継続。一度成功(23:26頃ping 8.8.8.8疎通)したが、再現性がなく約30分後に動作しなくなった。最終的にWXR経由IPv4に戻して安定運用を確保。

---

## 環境状態 (作業終了時点)

| 機器 | 状態 |
|------|------|
| VyOS | SSH接続可能 |
| WXR | ルーターモード (MAP-E有効) |
| IPv4経路 | WXR経由 (192.168.100.1) |
| IPv6経路 | NGN直接 (正常) |

---

## 成功したこと

### 1. MAP-E一時的成功 (23:26頃)

以下の設定でping 8.8.8.8が成功:

```bash
# BRアドレスを東日本BR (2001:260:700:1::1:275) に変更
sudo ip -6 tunnel add mape mode ip4ip6 \
    remote 2001:260:700:1::1:275 \
    local 2404:7a82:4d02:4100:85:d10d:200:4100 \
    dev eth1

# BRへの明示的ルートを追加
sudo ip -6 route add 2001:260:700:1::1:275/128 via fe80::a611:bbff:fe7d:ee11 dev eth1

sudo ip addr add 133.209.13.2/32 dev mape
sudo ip link set mape up
sudo ip route add default dev mape
```

**重要な発見**:
- DMR (`2404:9200:225:100::64`) ではなく東日本BR (`2001:260:700:1::1:275`) を使用
- BRへのルートはNGNゲートウェイ (`fe80::a611:bbff:fe7d:ee11`) 経由が必要

### 2. MACアドレス混同の解消

`docs/reference.md` に記載されていた情報:
- NGNゲートウェイ: `A4:11:BB:7D:EE:11` → `fe80::a611:bbff:fe7d:ee11`
- WXR: `F0:F8:4A:67:58:00` → `fe80::f2f8:4aff:fe67:5800`

### 3. WXR経由IPv4復旧

MAP-Eの再現性問題のため、安定運用を優先してWXR経由に復帰:

```bash
# VyOS設定
set protocols static route 0.0.0.0/0 next-hop 192.168.100.1
```

物理接続:
- eth0 (192.168.100.2) → WXR LAN1 (192.168.100.1)
- WXR WAN → LXW-10G5 → ONU

---

## 失敗・未解決

### 1. MAP-E再現性問題

23:26頃に成功した設定が、約30分後には動作しなくなった。

**調査したこと**:
- encaplimit (4 vs none): 関係なし
- rp_filter: 既に0 (disabled)
- VyOSネイティブ設定 (tun0): 動作せず

**考えられる原因**:
- BR側の状態変化 (セッションタイムアウト?)
- DHCPv6 S46オプション未取得による認証問題
- 不明

### 2. VyOSネイティブトンネル設定

```bash
set interfaces tunnel tun0 encapsulation ipip6
set interfaces tunnel tun0 source-address ...
set interfaces tunnel tun0 remote ...
set interfaces tunnel tun0 source-interface eth1
```

手動 `ip -6 tunnel add` では動作したが、VyOS設定では動作せず。

---

## 学んだこと

1. **docs/を最初に読む**: `reference.md`にMACアドレス一覧があった
2. **BRアドレスの使い分け**: DMRと実際のBRは異なる場合がある
3. **MAP-Eの再現性**: 一度動いても継続動作するとは限らない

---

## 次回やること

### 優先度高

1. **MAP-E再現性調査**
   - 成功時と失敗時のtcpdump比較
   - BR側の状態を推測する方法を検討

2. **VyOSネイティブ設定の調査**
   - 手動コマンドとVyOS設定の差分を詳細比較

### 優先度中

3. **全ポート範囲NAPT** (240ポート)
4. **設定の永続化スクリプト**

---

## 追加調査 (01:02頃)

### 発見した根本原因

**DHCPv6リース消失 → IPv6ルート消失 → BR到達不能 → MAP-E失敗**

| 項目 | 成功時(23:26) | 失敗時(30分後) |
|------|---------------|----------------|
| トンネルIF | UP | UP(見かけ上) |
| BRへのping | 通る | 通らなかった |
| DHCPv6リース | あった | 消えていた |

### dhcp6c再起動で復旧

```bash
sudo systemctl restart dhcp6c@eth1
# → リース再取得、BRへのping成功
```

### 次回実装タスク

1. **スタティックIPv6デフォルトルート追加**
   ```bash
   set protocols static route6 ::/0 next-hop fe80::a611:bbff:fe7d:ee11 interface eth1
   ```

2. **MAP-EトンネルをVyOS設定で再試行**
   ```bash
   set interfaces tunnel mape encapsulation ipip6
   set interfaces tunnel mape source-address 2404:7a82:4d02:4100:85:d10d:200:4100
   set interfaces tunnel mape remote 2001:260:700:1::1:275
   set interfaces tunnel mape source-interface eth1
   set interfaces tunnel mape address 133.209.13.2/32
   ```

3. **監視スクリプト検討** (オプション)

### 切り戻し手順

```bash
delete interfaces tunnel mape
delete protocols static route 0.0.0.0/0 interface mape
set protocols static route 0.0.0.0/0 next-hop 192.168.100.1
commit && save
```

---

## 参考情報

### MAP-Eパラメータ

| パラメータ | 値 |
|-----------|-----|
| CE Address | 2404:7a82:4d02:4100:85:d10d:200:4100 |
| BR (東日本) | 2001:260:700:1::1:275 |
| DMR | 2404:9200:225:100::64 |
| IPv4 Address | 133.209.13.2 |
| Port Range | 5136-5151 (他14ブロック) |

### 関連ドキュメント

- [MAP-E技術分析](mape-technical-analysis-2026-01-10.md)
- [TODO リスト](todo-mape-2026-01-11.md)
- [reference.md](reference.md) - MACアドレス一覧

---

## コマンドメモ

### 成功時のトンネル作成 (参考)

```bash
sudo ip -6 tunnel add mape mode ip4ip6 \
    remote 2001:260:700:1::1:275 \
    local 2404:7a82:4d02:4100:85:d10d:200:4100 \
    dev eth1
sudo ip -6 route add 2001:260:700:1::1:275/128 via fe80::a611:bbff:fe7d:ee11 dev eth1
sudo ip addr add 133.209.13.2/32 dev mape
sudo ip link set mape up
sudo ip route add default dev mape
```

### NAT設定

```bash
# iptables (手動)
sudo iptables -t nat -A POSTROUTING -o mape -p tcp -j SNAT --to-source 133.209.13.2:5136-5151
sudo iptables -t nat -A POSTROUTING -o mape -p udp -j SNAT --to-source 133.209.13.2:5136-5151
sudo iptables -t nat -A POSTROUTING -o mape -p icmp -j SNAT --to-source 133.209.13.2
```
