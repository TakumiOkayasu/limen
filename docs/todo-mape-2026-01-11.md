# MAP-E実装 TODOリスト (2026-01-11以降)

## 前提

- 2026-01-09: MAP-Eトンネル作成、パケット送信確認、**戻りパケットなし**
- 2026-01-10: 技術調査実施、rp_filter問題を発見

---

## 優先度高 (最初に試す)

### 1. rp_filter設定の確認・緩和

**目的**: 異なるBRアドレスからの応答パケットが破棄されている可能性を排除

```bash
# 現在の設定確認
[VyOS] cat /proc/sys/net/ipv4/conf/all/rp_filter
[VyOS] cat /proc/sys/net/ipv4/conf/eth1/rp_filter

# loose mode に変更 (VyOS設定)
[VyOS] configure
[VyOS] set interfaces ethernet eth1 ip source-validation loose
[VyOS] commit
```

- [ ] rp_filter現在値を確認
- [ ] loose modeに変更
- [ ] ping 8.8.8.8 で疎通確認

### 2. remote any でトンネル再作成

**目的**: 任意のBRアドレスからの応答を受信可能にする

```bash
[VyOS] sudo ip -6 tunnel del mape
[VyOS] sudo ip -6 tunnel add mape mode ip4ip6 \
    remote any \
    local 2404:7a82:4d02:4100:85:d10d:200:4100 \
    dev eth1
[VyOS] sudo ip addr add 133.209.13.2/32 dev mape
[VyOS] sudo ip link set mape up
[VyOS] sudo ip route add default dev mape
```

- [ ] 既存mapeトンネル削除
- [ ] remote any で再作成
- [ ] ping 8.8.8.8 で疎通確認

### 3. tcpdumpで応答確認

**目的**: パケットがどこまで来ているか切り分け

```bash
# 全てのip4ip6パケット
[VyOS] sudo tcpdump -i eth1 -n 'ip6 proto 4'

# 東日本BRからの応答確認
[VyOS] sudo tcpdump -i eth1 -n 'ip6 and host 2001:260:700:1::1:275'

# DMR BRからの応答確認
[VyOS] sudo tcpdump -i eth1 -n 'ip6 and host 2404:9200:225:100::64'
```

- [ ] 送信パケット確認 (BR宛)
- [ ] 応答パケット確認 (どのアドレスから来るか)

---

## 優先度中 (疎通確認後)

### 4. VyOSネイティブ設定への移行

**目的**: 設定の永続化、VyOS管理下に置く

```bash
[VyOS] configure
[VyOS] set interfaces tunnel tun0 encapsulation ipip6
[VyOS] set interfaces tunnel tun0 source-address 2404:7a82:4d02:4100:85:d10d:200:4100
[VyOS] set interfaces tunnel tun0 remote 2404:9200:225:100::64
[VyOS] set interfaces tunnel tun0 address 133.209.13.2/32
[VyOS] set interfaces tunnel tun0 ip source-validation loose
[VyOS] set protocols static route 0.0.0.0/0 interface tun0
[VyOS] commit
[VyOS] save
```

- [ ] VyOS tunnel設定作成
- [ ] 手動作成のmapeトンネル削除
- [ ] 動作確認

### 5. 全ポート範囲のNAPT設定

**目的**: 240ポート全てを使用可能にする

現在: 1ブロック (5136-5151) のみ
必要: 15ブロック (240ポート)

```bash
# rule 200-214 を作成
[VyOS] set nat source rule 200 outbound-interface name 'tun0'
[VyOS] set nat source rule 200 source address '192.168.1.0/24'
[VyOS] set nat source rule 200 protocol 'tcp_udp'
[VyOS] set nat source rule 200 translation address '133.209.13.2'
[VyOS] set nat source rule 200 translation port '5136-5151'
# ... rule 214 まで繰り返し (ポート範囲は claude_tmp/mape-params.txt 参照)
```

- [ ] 15ブロック分のNATルール作成
- [ ] 複数セッションが必要なサイトで動作確認

---

## 優先度低 (上記が失敗した場合)

### 6. 競合検証 (選択肢B)

**目的**: VyOSとWXRのDHCPv6-PD競合が原因かどうか確認

1. [ ] VyOSのDHCPv6を一時停止
2. [ ] WXRを再起動
3. [ ] WXRが「IPv6オプション」(MAP-E) を取得できるか確認
4. [ ] 取得できたら → 競合が原因
5. [ ] 取得できなければ → 別の問題

### 7. userland-ipip の検討

**目的**: カーネルip6tnlの信頼性問題を回避

- https://github.com/m13253/userland-ipip
- VyOSへのインストール可否を調査

---

## 参考情報

### BRアドレス

| 用途 | アドレス |
|------|---------|
| DMR (送信先) | 2404:9200:225:100::64 |
| 東日本BR | 2001:260:700:1::1:275 |
| 西日本BR | 2001:260:700:1::1:276 |

### MAP-Eパラメータ

- CEアドレス: 2404:7a82:4d02:4100:85:d10d:200:4100
- IPv4アドレス: 133.209.13.2
- ポート範囲: claude_tmp/mape-params.txt 参照

### 関連ドキュメント

- [技術分析レポート](mape-technical-analysis-2026-01-10.md)
- [昨日の作業ログ](work-log-2026-01-09.md)
- [BIGLOBE IPv6調査](report-biglobe-ipv6-wxr.md)
